(()=>{var N="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",x="8/8/8/8/8/8/8/8 w - - 0 1",b=class a{constructor(s){this.FEN=s||x}set FEN(s){let e=s.split(" "),t=e[0].split("/").map(f=>{let d=[];for(let c of f.split(""))if(c>="0"&&c<="9")for(let l=0;l<c-"0";++l)d.push(null);else d.push(c);return d}),i=e[1].toLowerCase(),n=e[2].split(""),r=e[3]!="-"?e[3]:null,u=e[4],h=e[5];this.pieces=t,this.activeColor=i,this.castling={whiteKingSide:n.includes("K"),whiteQueenSide:n.includes("Q"),blackKingSide:n.includes("k"),blackQueenSide:n.includes("q")},this.enPassant=r,this.halfmoves=u,this.fullmoves=h}get FEN(){let s=this.pieces.map(i=>{let n="",r=0;for(let u of i)u?r>0?(n+=r+u,r=0):n+=u:r++;return r>0&&(n+=r),n}).join("/"),e="";e+=this.castling.whiteKingSide?"K":"",e+=this.castling.whiteQueenSide?"Q":"",e+=this.castling.blackKingSide?"k":"",e+=this.castling.blackQueenSide?"q":"";let t=this.enPassant||"-";return[s,this.activeColor,e,t,this.halfmoves,this.fullmoves].join(" ")}getPiece(s,e){return this.pieces[s-1][e-1]}setPiece(s,e,t){this.pieces[s-1][e-1]=t}makeMove(s){let{srcRow:e,srcColumn:t,dstRow:i,dstColumn:n,promotionTarget:r}=s,u=this.getPiece(i,n),h=this.getPiece(e,t);this.setPiece(i,n,h),this.setPiece(e,t,null);let f=h==="P"||h==="p",d=f&&n!==t&&!u,c=u||d,l="Kk".includes(h)&&Math.abs(n-t)>=2;d?this.setPiece(e,n,null):f&&(i===1||i===8)?this.setPiece(i,n,S(r||"Q",m(h))):l&&(h==="K"?this.castling.whiteQueenSide=this.castling.whiteKingSide=!1:this.castling.blackQueenSide=this.castling.blackKingSide=!1,n>t?(this.setPiece(i,n-1,this.getPiece(i,8)),this.setPiece(i,8,null)):(this.setPiece(i,n+1,this.getPiece(i,1)),this.setPiece(i,1,null))),h==="R"&&e===8&&t===1?this.castling.whiteQueenSide=!1:h==="R"&&e===8&&t===8?this.castling.whiteKingSide=!1:h==="r"&&e===1&&t===1?this.castling.blackQueenSide=!1:h==="r"&&e===1&&t===8&&(this.castling.blackKingSide=!1),(f||c)&&this.halfmoves++,f&&Math.abs(e-i)===2?this.enPassant=g((e+i)/2,t):this.enPassant=null,this.activeColor==="b"?(this.fullmoves++,this.activeColor="w"):this.activeColor="b"}*getPieces(){for(let s=0;s<8;++s)for(let e=0;e<8;++e)this.pieces[s][e]&&(yield{row:s+1,column:e+1,piece:this.pieces[s][e]})}getPossibleMoves(s){let[e,t]=s,i=this.pieces,n=(o,p)=>i[o-1][p-1],r=n(e,t);if(!r)throw new Error(`no piece at ${s} for board`,this);let u=m(r),h=(o,p)=>{let v=n(o,p);return v?m(v)!==u:!1},f=(o,p)=>{let v=n(o,p);return v?m(v)!==u:!0},d=([o,p])=>o>0&&o<=8&&p>0&&p<=8&&f(o,p),c=(o,p,v)=>{for(let k=p;k<v;++k)if(n(o,k))return!1;return!0},l=[];if(r==="P")n(e-1,t)||(l.push([e-1,t]),e==7&&!n(e-2,t)&&l.push([e-2,t])),(h(e-1,t-1)||g(e-1,t-1)===this.enPassant)&&l.push([e-1,t-1]),(h(e-1,t+1)||g(e-1,t+1)===this.enPassant)&&l.push([e-1,t+1]);else if(r==="p")n(e+1,t)||(l.push([e+1,t]),e==2&&!n(e+2,t)&&l.push([e+2,t])),(h(e+1,t-1)||g(e+1,t-1)===this.enPassant)&&l.push([e+1,t-1]),(h(e+1,t+1)||g(e+1,t+1)===this.enPassant)&&l.push([e+1,t+1]);else if(r==="R"||r==="r"||r==="Q"||r==="q"){for(let o=e-1;o>0&&(f(o,t)&&l.push([o,t]),!n(o,t));--o);for(let o=e+1;o<=8&&(f(o,t)&&l.push([o,t]),!n(o,t));++o);for(let o=t-1;o>0&&(f(e,o)&&l.push([e,o]),!n(e,o));--o);for(let o=t+1;o<=8&&(f(e,o)&&l.push([e,o]),!n(e,o));++o);}else r==="K"||r==="k"?(l=[[e-1,t-1],[e-1,t],[e-1,t+1],[e,t-1],[e,t+1],[e+1,t-1],[e+1,t],[e+1,t+1]].filter(d),r==="K"&&this.castling.whiteKingSide&&c(e,t+1,8)&&l.push([e,t+2]),r==="K"&&this.castling.whiteQueenSide&&c(e,2,t)&&l.push([e,t-2]),r==="k"&&this.castling.blackKingSide&&c(e,t+1,8)&&l.push([e,t+2]),r==="k"&&this.castling.blackQueenSide&&c(e,2,t)&&l.push([e,t-2])):(r==="N"||r==="n")&&(l=[[e+2,t+1],[e-2,t+1],[e+1,t+2],[e-1,t+2],[e+2,t-1],[e-2,t-1],[e+1,t-2],[e-1,t-2]].filter(d));if(r==="B"||r==="b"||r==="Q"||r==="q"){for(let o=1;e+o<=8&&t+o<=8&&(f(e+o,t+o)&&l.push([e+o,t+o]),!n(e+o,t+o));++o);for(let o=1;e+o<=8&&t-o>0&&(f(e+o,t-o)&&l.push([e+o,t-o]),!n(e+o,t-o));++o);for(let o=1;e-o>0&&t+o<=8&&(f(e-o,t+o)&&l.push([e-o,t+o]),!n(e-o,t+o));++o);for(let o=1;e-o>0&&t-o>0&&(f(e-o,t-o)&&l.push([e-o,t-o]),!n(e-o,t-o));++o);}return r==="P"&&e==2||r==="p"&&e==7?l.map(([o,p])=>"QRBN".split("").map(v=>({srcPiece:r,srcRow:e,srcColumn:t,dstRow:o,dstColumn:p,promotionTarget:v}))).flat():l.map(([o,p])=>({srcPiece:r,srcRow:e,srcColumn:t,dstRow:o,dstColumn:p}))}getPossibleMoveTargets(s){return this.getPossibleMoves(P(s)).map(({dstRow:e,dstColumn:t})=>g(e,t))}getLegalMoveTargets(s){return this.getLegalMoves(P(s)).map(({dstRow:e,dstColumn:t})=>g(e,t))}getPiecesOfColor(s){return this.getPieces().filter(({row:e,column:t,piece:i})=>m(i)===s)}getAllPossibleMoves(){return this.getPiecesOfColor(this.activeColor).reduce((s,{row:e,column:t,piece:i})=>s.concat(this.getPossibleMoves([e,t])),[])}getAllThreats(){return this.getAllPossibleMoves().filter(({dstRow:s,dstColumn:e})=>this.getPiece(s,e)!=null)}getLegalMoves(s){return this.getPossibleMoves(s).filter(e=>{let t=new a(this.FEN);t.makeMove(e);let i=t.getPiecesOfColor(this.activeColor).find(({piece:u})=>u.toUpperCase()==="K"),n=g(i.row,i.column);return!t.getAllThreats().map(u=>g(u.dstRow,u.dstColumn)).includes(n)})}getAllLegalMoves(){return this.getPiecesOfColor(this.activeColor).reduce((s,{row:e,column:t,piece:i})=>s.concat(this.getLegalMoves([e,t])),[])}resolveMove(s){let e=s.replace("x","").replace("+",""),t=this.getAllLegalMoves(),i,n,r,u,h,f,d=null;if(d=e.match(/^([a-h])([1-8])(=([QRNB]))?$/))i="P",h=d[1],u=d[2],f=d[4];else if(d=e.match(/^([a-h])([1-8]?)([a-h])([1-8]?)(=([QRNB]))?$/))i="P",r=d[1],n=d[2],h=d[3],u=d[4],f=d[6];else if(d=e.match(/^([RNBKQ])([a-h])?([1-8])?([a-h])([1-8])$/))i=d[1],r=d[2],n=d[3],h=d[4],u=d[5];else if(e.match("^[0O]-[0O]$"))t=t.filter(c=>c.srcPiece.toUpperCase()=="K"&&c.dstColumn-c.srcColumn>1);else if(e.match("^[0O]-[0O]-[0O]$"))t=t.filter(c=>c.srcPiece.toUpperCase()=="K"&&c.srcColumn-c.dstColumn>1);else throw new Error(`invalid move notation '${e}'`);if(i&&(t=t.filter(c=>c.srcPiece.toUpperCase()===i)),r){let c="abcdefgh".indexOf(r)+1;t=t.filter(l=>l.srcColumn===c)}if(n){let c="87654321".indexOf(n)+1;t=t.filter(l=>l.srcRow===c)}if(h){let c="abcdefgh".indexOf(h)+1;t=t.filter(l=>l.dstColumn===c)}if(u){let c="87654321".indexOf(u)+1;t=t.filter(l=>l.dstRow===c)}if(f&&(t=t.filter(c=>c.promotionTarget===f)),t.length===1?console.log(e,"OK!"):(console.log(`illegal/ambiguous move ${e}. FEN: '${this.FEN}', candidates`,t),console.log(`filter: srcPiece '${i}' srcColumn '${r}' srcRow ${n} dstColumn ${h} dstRow ${u} promotion ${f}`)),t.length===0)throw new Error(`move ${e} is not legal in current position`);if(t.length>1)throw new Error(`move ${e} is ambiguous`);return t[0]}};function S(a,s){return s==="w"?a.toUpperCase():a.toLowerCase()}function m(a){return a.toUpperCase()===a?"w":"b"}function g(a,s){return"abcdefgh"[s-1]+(9-a)}function P(a){if(a.length==2){let s="abcdefgh".split("").indexOf(a[0])+1,e="87654321".split("").indexOf(a[1])+1;if(e>0&&s>0)return[e,s]}}function M(a){let s=new b(N);for(let e of a)s.makeMove(s.resolveMove(e));return s.FEN}function F(a){let{srcRow:s,srcColumn:e,srcPiece:t,dstRow:i,dstColumn:n,promotionTarget:r}=a,u=t.toUpperCase()!=="P"?t.toUpperCase():"",h=g(s,e),f=g(i,n);return u+h+f}var w=class{moveEventListeners=[];constructor(s){this.board=new b,this.$boardElem=$(`#${s}`),this.selectedCell=null}deselectSelectedCell(){this.$boardElem.children(".possible-move").remove(),this.$boardElem.children(".selected").removeClass("selected"),this.selectedCell=null}handleClick(s,e){let t=g(s,e);if(this.selectedCell&&this.board.getLegalMoveTargets(this.selectedCell).includes(t)){let i=P(this.selectedCell),n={srcRow:i[0],srcColumn:i[1],srcPiece:this.board.getPiece(i[0],i[1]),dstRow:s,dstColumn:e,promotionTarget:"Q"};this.board.makeMove(n),this.selectedCell=null,this.render();for(let r of this.moveEventListeners)r(n)}else{this.deselectSelectedCell();let i=this.board.getPiece(s,e);if(i&&this.board.activeColor===m(i)){this.$boardElem.children(`.cell[value="${t}"]`).addClass("selected"),this.selectedCell=t;for(let{dstRow:n,dstColumn:r}of this.board.getLegalMoves([s,e]))this.$boardElem.append($('<div class="possible-move"></div>').css({"grid-row":n,"grid-column":r}))}}}render(){let s=(t,i,n)=>{t!==null&&this.$boardElem.append($("<div></div>").addClass(I(t)).val(g(i,n)).css({"grid-row":i,"grid-column":n}).click(()=>{this.handleClick(i,n)}))},e=(t,i)=>{let n=(t+i)%2==0?"white":"black";this.$boardElem.append($("<div></div>").addClass(n).addClass("cell").val(g(t,i)).css({"grid-row":t,"grid-column":i}).click(()=>{this.handleClick(t,i)}))};this.$boardElem.empty();for(let t=0;t<8;++t)for(let i=0;i<8;++i)e(t+1,i+1),s(this.board.pieces[t][i],t+1,i+1)}resetToFEN(s){this.board.FEN=s,this.selectedCell=null,this.render()}addMoveEventListener(s){this.moveEventListeners.push(s)}};function I(a){let s=a.toUpperCase()===a?"white ":"black ";switch(a.toLowerCase()){case"k":return s+"king";case"q":return s+"queen";case"r":return s+"rook";case"b":return s+"bishop";case"n":return s+"knight";case"p":return s+"pawn"}}var E=class{moves=[];curMoveIndex=0;moveEventListeners=[];constructor(s){this.$tableElem=$(`#${s}`)}reset(s=[]){this.moves=s,this.curMoveIndex=0,this.render()}#e(){for(let s of this.moveEventListeners)s(this.curMoveIndex)}render(){let s=e=>{let t=this.curMoveIndex;this.setCurrentMove(e),t!==this.curMoveIndex&&this.#e()};this.$tableElem.empty();for(let e=0;e<this.moves.length;e+=2){let t=$("<tr></tr>");t.append(`<th>${e/2+1}</th>`),t.append($(`<td>${this.moves[e]}</td>`).click(()=>{s(e)})),this.moves[e+1]&&t.append($(`<td>${this.moves[e+1]}</td>`).click(()=>{s(e+1)})),this.$tableElem.append(t)}this.setCurrentMove(this.curMoveIndex)}constrainMoveIndex(s){return s<0||this.moves.length===0?0:s>=this.moves.length?this.moves.length-1:s}getCurrentMoveIndex(){return this.curMoveIndex}setCurrentMove(s){s=this.constrainMoveIndex(s),this.$tableElem.find("td").removeClass("active"),this.$tableElem.find(`tr:nth-child(${Math.floor(s/2)+1}) td:nth-of-type(${s%2+1})`).addClass("active"),this.curMoveIndex=s}focusTop(s){if(this.moves.length===0)return;s=this.constrainMoveIndex(s);let e=this.$tableElem.parent(),i=this.$tableElem.find("td").eq(s).position().top;e.get(0).scrollTo(0,i)}focusBottom(s){if(this.moves.length===0)return;s=this.constrainMoveIndex(s);let e=this.$tableElem.parent(),t=this.$tableElem.find("td").eq(s),i=t.position().top+t.height();e.get(0).scrollTo(0,i-e.height())}isFullyVisible(s){if(this.moves.length===0)return!0;s=this.constrainMoveIndex(s);let e=this.$tableElem.parent(),t=e.get(0),i=this.$tableElem.find("td").eq(s),n=i.position().top,r=i.position().top+i.height();return n>=t.scrollTop&&r<=t.scrollTop+e.height()}gotoNextMove(){this.setCurrentMove(this.curMoveIndex+1),this.isFullyVisible(this.curMoveIndex)||this.focusBottom(this.curMoveIndex),this.#e()}gotoPrevMove(){this.setCurrentMove(this.curMoveIndex-1),this.isFullyVisible(this.curMoveIndex)||this.focusTop(this.curMoveIndex),this.#e()}gotoFirstMove(){this.setCurrentMove(0),this.focusBottom(this.curMoveIndex),this.#e()}gotoLastMove(){this.setCurrentMove(this.moves.length-1),this.focusBottom(this.curMoveIndex),this.#e()}pushMove(s){this.moves=this.moves.slice(0,this.curMoveIndex+1),this.moves.push(s),this.curMoveIndex+=1,this.render(),this.focusBottom(this.curMoveIndex)}getCurrentFEN(){return M(this.moves.slice(0,this.curMoveIndex+1))}addMoveEventListener(s){this.moveEventListeners.push(s)}};var K=new URLSearchParams(document.location.search),R=K.get("FEN"),C=document.getElementById("fen-input"),U=document.getElementById("fen-copy");function T(){return C.value||C.placeholder}$(document).ready(()=>{let a=new w("main-board"),s=new E("main-pgn-table"),e=i=>{$(C).val(i),a.resetToFEN(i),s.reset()},t=i=>{let n=M(i);$(C).val(n),a.resetToFEN(n),s.reset(i),s.setCurrentMove(i.length-1),s.focusBottom(i.length-1)};$("#btn-starting-position").click(()=>{e(N)}),$("#btn-clear-board").click(()=>{e(x)}),$("#btn-random-puzzle").click(()=>{$.getJSON("https://lichess.org/api/puzzle/next",n=>{console.log("puzzle data",n);let r=n.game.pgn.split(" ");t(r)})}),$("#fen-copy").click(()=>{navigator.clipboard.writeText(T())}),$("#fen-input").on("input",()=>{e(T())}),s.addMoveEventListener(()=>{let i=s.getCurrentFEN();a.resetToFEN(i),$(C).val(i)}),a.addMoveEventListener(i=>{s.pushMove(F(i)),$(C).val(a.board.FEN)}),document.addEventListener("keydown",i=>{i.code==="ArrowRight"?s.gotoNextMove():i.code==="ArrowLeft"?s.gotoPrevMove():i.code==="ArrowUp"?s.gotoFirstMove():i.code==="ArrowDown"&&s.gotoLastMove()}),e(R||T())});})();
//# sourceMappingURL=main.js.map
