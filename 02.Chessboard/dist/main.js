(()=>{var eM={},lM={};function sL(M,L){try{localStorage.setItem(`settings-${M}`,L)}catch(j){console.error(`Failed to save setting ${M}=${L} in localStorage:`,j)}}var zM={theme:"dark",movement:"both",boardStyle:"blue"},p={keys(){return zM.keys()},get(M){if(!zM.hasOwnProperty(M))throw new Error("invalid setting '{key}'");if(!lM.hasOwnProperty(M)){let L=localStorage.getItem(`settings-${M}`);L||(L=zM[M],sL(M,L)),lM[M]=L}return lM[M]},set(M,L){let j=this.get(M);lM[M]=L,sL(M,L),L!=j&&eM[M]&&eM[M].forEach(N=>{N(L)})},reset(){for(let M in zM)this.set(M,zM[M])},onchange(M,L){eM[M]||(eM[M]=[]),eM[M].push(L)}};var cM=[{name:"blue",image:"./assets/board/lichess/blue.png"},{name:"brown",image:"./assets/board/lichess/brown.png"},{name:"wood",image:"./assets/board/lichess/wood.jpg"},{name:"maple",image:"./assets/board/lichess/maple.jpg"},{name:"green",image:"./assets/board/lichess/green.png"},{name:"legacy",image:"./assets/board/pale-green.svg"}];document.head.appendChild(document.createElement("style")).innerHTML=cM.map(({name:M,image:L})=>`.${M} cg-board { background-image: url(${L}) }`).join(`
`);var XM=class extends HTMLElement{_render(){let L=p.get("theme"),j=p.get("movement"),N=p.get("boardStyle"),u=cM.map(({name:I,image:t})=>`
      <button class="overflow-hidden border ${I===N?"border-primary border-3":"border-secondary-subtle"} m-0 p-0"
              style="width: 20%; aspect-ratio: 1"
              data-settings-key="boardStyle" data-settings-value="${I}">
        <img src="${t}" style="width: 402%; height: 402%">
      </button>
    `).join("");$(this).addClass("offcanvas offcanvas-end").attr("tabindex","-1").html(`
      <div class="offcanvas-header">
        <h4 class="offcanvas-title">Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
          <li class="nav-item mb-2">
            <h6>Theme</h6>
            <div class="btn-group w-100" role="group" aria-label="Select theme">
              <input type="radio" class="btn-check" name="settings-theme"
                     id="settings-theme-light" value="light" autocomplete="off"
                     ${L==="light"?"checked":""}>
              <label class="btn btn-outline-primary" for="settings-theme-light">Light</label>
              <input type="radio" class="btn-check" name="settings-theme"
                     id="settings-theme-dark" value="dark" autocomplete="off"
                     ${L==="dark"?"checked":""}>
              <label class="btn btn-outline-primary" for="settings-theme-dark">Dark</label>
            </div>
          </li>
          <li class="nav-item mb-2">
            <h6>Piece movement</h6>
            <div class="btn-group w-100" role="group" aria-label="Select piece movement style">
              <input type="radio" class="btn-check" name="settings-movement"
                     id="settings-movement-drag" value="drag" autocomplete="off"
                     ${j==="drag"?"checked":""}>
              <label class="btn btn-outline-primary" for="settings-movement-drag">Drag</label>
              <input type="radio" class="btn-check" name="settings-movement"
                     id="settings-movement-click" value="click" autocomplete="off"
                     ${j==="click"?"checked":""}>
              <label class="btn btn-outline-primary" for="settings-movement-click">Click</label>
              <input type="radio" class="btn-check" name="settings-movement"
                     id="settings-movement-both" value="both" autocomplete="off"
                     ${j==="both"?"checked":""}>
              <label class="btn btn-outline-primary" for="settings-movement-both">Both</label>
            </div>
          </li>
          <li class="nav-item mb-2">
            <h6>Board style</h6>
            <div class="w-100 d-flex flex-wrap gap-2">
              ${u}
            </div>
          </li>
          <hr>
          <li class="mb" style="margin: 0 auto;">
            <button class="btn btn-danger" data-btn-id="reset">Reset to defaults</button>
          </li>
        </ul>
      </div>
    `),$(this).find('input[type="radio"][name="settings-theme"]').click(function(){p.set("theme",$(this).attr("value"))}),$(this).find('input[type="radio"][name="settings-movement"]').click(function(){p.set("movement",$(this).attr("value"))}),$(this).find('button[data-settings-key="boardStyle"').click(function(){$(this).siblings().removeClass("border-primary border-3").addClass("border-secondary-subtle"),$(this).addClass("border-primary border-3").removeClass("border-secondary-subtle"),p.set("boardStyle",$(this).attr("data-settings-value"))}),$(this).find('button[data-btn-id="reset"]').click(()=>{p.reset(),this._render()})}connectedCallback(){this._render()}};customElements.define("settings-bar",XM);var FM=class extends HTMLElement{connectedCallback(){$(this).html(`
      <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">chessboard</a>
          <button class="navbar-toggler border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#settings" aria-controls="settings" aria-label="Toggle settings">
            <i class="fa fa-regular fa-gear"></i>
          </button>
          <settings-bar id="settings"></settings-bar>
        </div>
      </nav>
    `)}};customElements.define("nav-bar",FM);var l="w",v="b",Q="p",LL="n",kM="b",EM="r",MM="q",w="k",qM="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",DM=class{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(L,j){let{color:N,piece:u,from:I,to:t,flags:g,captured:i,promotion:y}=j,A=d(I),T=d(t);this.color=N,this.piece=u,this.from=A,this.to=T,this.san=L._moveToSan(j,L._moves({legal:!0})),this.lan=A+T,this.before=L.fen(),L._makeMove(j),this.after=L.fen(),L._undoMove(),this.flags="";for(let D in c)c[D]&g&&(this.flags+=IM[D]);i&&(this.captured=i),y&&(this.promotion=y,this.lan+=y)}isCapture(){return this.flags.indexOf(IM.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(IM.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(IM.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(IM.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(IM.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(IM.BIG_PAWN)>-1}},f=-1,IM={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},UL=["a8","b8","c8","d8","e8","f8","g8","h8","a7","b7","c7","d7","e7","f7","g7","h7","a6","b6","c6","d6","e6","f6","g6","h6","a5","b5","c5","d5","e5","f5","g5","h5","a4","b4","c4","d4","e4","f4","g4","h4","a3","b3","c3","d3","e3","f3","g3","h3","a2","b2","c2","d2","e2","f2","g2","h2","a1","b1","c1","d1","e1","f1","g1","h1"],c={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},x={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},$M={b:[16,32,17,15],w:[-16,-32,-17,-15]},YL={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Gj=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Wj=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Hj={p:1,n:2,b:4,r:8,q:16,k:32},Rj="pnbrqkPNBRQK",wL=[LL,kM,EM,MM],Vj=7,_j=6,Bj=1,Jj=0,dM={[w]:c.KSIDE_CASTLE,[MM]:c.QSIDE_CASTLE},q={w:[{square:x.a1,flag:c.QSIDE_CASTLE},{square:x.h1,flag:c.KSIDE_CASTLE}],b:[{square:x.a8,flag:c.QSIDE_CASTLE},{square:x.h8,flag:c.KSIDE_CASTLE}]},Xj={b:Bj,w:_j},Fj=["1-0","0-1","1/2-1/2","*"];function tM(M){return M>>4}function CM(M){return M&15}function lL(M){return"0123456789".indexOf(M)!==-1}function d(M){let L=CM(M),j=tM(M);return"abcdefgh".substring(L,L+1)+"87654321".substring(j,j+1)}function xM(M){return M===l?v:l}function qj(M){let L=M.split(/\s+/);if(L.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let j=parseInt(L[5],10);if(isNaN(j)||j<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let N=parseInt(L[4],10);if(isNaN(N)||N<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(L[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(L[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(L[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let u=L[0].split("/");if(u.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let t=0;t<u.length;t++){let g=0,i=!1;for(let y=0;y<u[t].length;y++)if(lL(u[t][y])){if(i)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};g+=parseInt(u[t][y],10),i=!0}else{if(!/^[prnbqkPRNBQK]$/.test(u[t][y]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};g+=1,i=!1}if(g!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(L[3][1]=="3"&&L[1]=="w"||L[3][1]=="6"&&L[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let I=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:t,regex:g}of I){if(!g.test(L[0]))return{ok:!1,error:`Invalid FEN: missing ${t} king`};if((L[0].match(g)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${t} kings`}}return Array.from(u[0]+u[7]).some(t=>t.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function $j(M,L){let j=M.from,N=M.to,u=M.piece,I=0,t=0,g=0;for(let i=0,y=L.length;i<y;i++){let A=L[i].from,T=L[i].to,D=L[i].piece;u===D&&j!==A&&N===T&&(I++,tM(j)===tM(A)&&t++,CM(j)===CM(A)&&g++)}return I>0?t>0&&g>0?d(j):g>0?d(j).charAt(1):d(j).charAt(0):""}function K(M,L,j,N,u,I=void 0,t=c.NORMAL){let g=tM(N);if(u===Q&&(g===Vj||g===Jj))for(let i=0;i<wL.length;i++){let y=wL[i];M.push({color:L,from:j,to:N,piece:u,captured:I,promotion:y,flags:t|c.PROMOTION})}else M.push({color:L,from:j,to:N,piece:u,captured:I,flags:t})}function QL(M){let L=M.charAt(0);return L>="a"&&L<="h"?M.match(/[a-h]\d.*[a-h]\d/)?void 0:Q:(L=L.toLowerCase(),L==="o"?w:L)}function KM(M){return M.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function ML(M){return M.split(" ").slice(0,4).join(" ")}var TM=class{_board=new Array(128);_turn=l;_header={};_kings={w:f,b:f};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_positionCount={};constructor(L=qM,{skipValidation:j=!1}={}){this.load(L,{skipValidation:j})}clear({preserveHeaders:L=!1}={}){this._board=new Array(128),this._kings={w:f,b:f},this._turn=l,this._castling={w:0,b:0},this._epSquare=f,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=L?this._header:{},this._positionCount={},delete this._header.SetUp,delete this._header.FEN}load(L,{skipValidation:j=!1,preserveHeaders:N=!1}={}){let u=L.split(/\s+/);if(u.length>=2&&u.length<6){let g=["-","-","0","1"];L=u.concat(g.slice(-(6-u.length))).join(" ")}if(u=L.split(/\s+/),!j){let{ok:g,error:i}=qj(L);if(!g)throw new Error(i)}let I=u[0],t=0;this.clear({preserveHeaders:N});for(let g=0;g<I.length;g++){let i=I.charAt(g);if(i==="/")t+=8;else if(lL(i))t+=parseInt(i,10);else{let y=i<"a"?l:v;this._put({type:i.toLowerCase(),color:y},d(t)),t++}}this._turn=u[1],u[2].indexOf("K")>-1&&(this._castling.w|=c.KSIDE_CASTLE),u[2].indexOf("Q")>-1&&(this._castling.w|=c.QSIDE_CASTLE),u[2].indexOf("k")>-1&&(this._castling.b|=c.KSIDE_CASTLE),u[2].indexOf("q")>-1&&(this._castling.b|=c.QSIDE_CASTLE),this._epSquare=u[3]==="-"?f:x[u[3]],this._halfMoves=parseInt(u[4],10),this._moveNumber=parseInt(u[5],10),this._updateSetup(L),this._incPositionCount(L)}fen(){let L=0,j="";for(let I=x.a8;I<=x.h1;I++){if(this._board[I]){L>0&&(j+=L,L=0);let{color:t,type:g}=this._board[I];j+=t===l?g.toUpperCase():g.toLowerCase()}else L++;I+1&136&&(L>0&&(j+=L),I!==x.h1&&(j+="/"),L=0,I+=8)}let N="";this._castling[l]&c.KSIDE_CASTLE&&(N+="K"),this._castling[l]&c.QSIDE_CASTLE&&(N+="Q"),this._castling[v]&c.KSIDE_CASTLE&&(N+="k"),this._castling[v]&c.QSIDE_CASTLE&&(N+="q"),N=N||"-";let u="-";if(this._epSquare!==f){let I=this._epSquare+(this._turn===l?16:-16),t=[I+1,I-1];for(let g of t){if(g&136)continue;let i=this._turn;if(this._board[g]?.color===i&&this._board[g]?.type===Q){this._makeMove({color:i,from:g,to:this._epSquare,piece:Q,captured:Q,flags:c.EP_CAPTURE});let y=!this._isKingAttacked(i);if(this._undoMove(),y){u=d(this._epSquare);break}}}}return[j,this._turn,N,u,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(L){this._history.length>0||(L!==qM?(this._header.SetUp="1",this._header.FEN=L):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(qM)}get(L){return this._board[x[L]]}put({type:L,color:j},N){return this._put({type:L,color:j},N)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_put({type:L,color:j},N){if(Rj.indexOf(L.toLowerCase())===-1||!(N in x))return!1;let u=x[N];if(L==w&&!(this._kings[j]==f||this._kings[j]==u))return!1;let I=this._board[u];return I&&I.type===w&&(this._kings[I.color]=f),this._board[u]={type:L,color:j},L===w&&(this._kings[j]=u),!0}remove(L){let j=this.get(L);return delete this._board[x[L]],j&&j.type===w&&(this._kings[j.color]=f),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),j}_updateCastlingRights(){let L=this._board[x.e1]?.type===w&&this._board[x.e1]?.color===l,j=this._board[x.e8]?.type===w&&this._board[x.e8]?.color===v;(!L||this._board[x.a1]?.type!==EM||this._board[x.a1]?.color!==l)&&(this._castling.w&=~c.QSIDE_CASTLE),(!L||this._board[x.h1]?.type!==EM||this._board[x.h1]?.color!==l)&&(this._castling.w&=~c.KSIDE_CASTLE),(!j||this._board[x.a8]?.type!==EM||this._board[x.a8]?.color!==v)&&(this._castling.b&=~c.QSIDE_CASTLE),(!j||this._board[x.h8]?.type!==EM||this._board[x.h8]?.color!==v)&&(this._castling.b&=~c.KSIDE_CASTLE)}_updateEnPassantSquare(){if(this._epSquare===f)return;let L=this._epSquare+(this._turn===l?-16:16),j=this._epSquare+(this._turn===l?16:-16),N=[j+1,j-1];if(this._board[L]!==null||this._board[this._epSquare]!==null||this._board[j]?.color!==xM(this._turn)||this._board[j]?.type!==Q){this._epSquare=f;return}let u=I=>!(I&136)&&this._board[I]?.color===this._turn&&this._board[I]?.type===Q;N.some(u)||(this._epSquare=f)}_attacked(L,j,N){let u=[];for(let I=x.a8;I<=x.h1;I++){if(I&136){I+=7;continue}if(this._board[I]===void 0||this._board[I].color!==L)continue;let t=this._board[I],g=I-j;if(g===0)continue;let i=g+119;if(Gj[i]&Hj[t.type]){if(t.type===Q){if(g>0&&t.color===l||g<=0&&t.color===v)if(N)u.push(d(I));else return!0;continue}if(t.type==="n"||t.type==="k")if(N){u.push(d(I));continue}else return!0;let y=Wj[i],A=I+y,T=!1;for(;A!==j;){if(this._board[A]!=null){T=!0;break}A+=y}if(!T)if(N){u.push(d(I));continue}else return!0}}return N?u:!1}attackers(L,j){return j?this._attacked(j,x[L],!0):this._attacked(this._turn,x[L],!0)}_isKingAttacked(L){let j=this._kings[L];return j===-1?!1:this._attacked(xM(L),j)}isAttacked(L,j){return this._attacked(j,x[L])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let L={b:0,n:0,r:0,q:0,k:0,p:0},j=[],N=0,u=0;for(let I=x.a8;I<=x.h1;I++){if(u=(u+1)%2,I&136){I+=7;continue}let t=this._board[I];t&&(L[t.type]=t.type in L?L[t.type]+1:1,t.type===kM&&j.push(u),N++)}if(N===2)return!0;if(N===3&&(L[kM]===1||L[LL]===1))return!0;if(N===L[kM]+2){let I=0,t=j.length;for(let g=0;g<t;g++)I+=j[g];if(I===0||I===t)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this.fen())>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:L=!1,square:j=void 0,piece:N=void 0}={}){let u=this._moves({square:j,piece:N});return L?u.map(I=>new DM(this,I)):u.map(I=>this._moveToSan(I,u))}_moves({legal:L=!0,piece:j=void 0,square:N=void 0}={}){let u=N?N.toLowerCase():void 0,I=j?.toLowerCase(),t=[],g=this._turn,i=xM(g),y=x.a8,A=x.h1,T=!1;if(u)if(u in x)y=A=x[u],T=!0;else return[];for(let S=y;S<=A;S++){if(S&136){S+=7;continue}if(!this._board[S]||this._board[S].color===i)continue;let{type:z}=this._board[S],e;if(z===Q){if(I&&I!==z)continue;e=S+$M[g][0],this._board[e]||(K(t,g,S,e,Q),e=S+$M[g][1],Xj[g]===tM(S)&&!this._board[e]&&K(t,g,S,e,Q,void 0,c.BIG_PAWN));for(let n=2;n<4;n++)e=S+$M[g][n],!(e&136)&&(this._board[e]?.color===i?K(t,g,S,e,Q,this._board[e].type,c.CAPTURE):e===this._epSquare&&K(t,g,S,e,Q,Q,c.EP_CAPTURE))}else{if(I&&I!==z)continue;for(let n=0,o=YL[z].length;n<o;n++){let r=YL[z][n];for(e=S;e+=r,!(e&136);){if(!this._board[e])K(t,g,S,e,z);else{if(this._board[e].color===g)break;K(t,g,S,e,z,this._board[e].type,c.CAPTURE);break}if(z===LL||z===w)break}}}}if((I===void 0||I===w)&&(!T||A===this._kings[g])){if(this._castling[g]&c.KSIDE_CASTLE){let S=this._kings[g],z=S+2;!this._board[S+1]&&!this._board[z]&&!this._attacked(i,this._kings[g])&&!this._attacked(i,S+1)&&!this._attacked(i,z)&&K(t,g,this._kings[g],z,w,void 0,c.KSIDE_CASTLE)}if(this._castling[g]&c.QSIDE_CASTLE){let S=this._kings[g],z=S-2;!this._board[S-1]&&!this._board[S-2]&&!this._board[S-3]&&!this._attacked(i,this._kings[g])&&!this._attacked(i,S-1)&&!this._attacked(i,z)&&K(t,g,this._kings[g],z,w,void 0,c.QSIDE_CASTLE)}}if(!L||this._kings[g]===-1)return t;let D=[];for(let S=0,z=t.length;S<z;S++)this._makeMove(t[S]),this._isKingAttacked(g)||D.push(t[S]),this._undoMove();return D}move(L,{strict:j=!1}={}){let N=null;if(typeof L=="string")N=this._moveFromSan(L,j);else if(typeof L=="object"){let I=this._moves();for(let t=0,g=I.length;t<g;t++)if(L.from===d(I[t].from)&&L.to===d(I[t].to)&&(!("promotion"in I[t])||L.promotion===I[t].promotion)){N=I[t];break}}if(!N)throw typeof L=="string"?new Error(`Invalid move: ${L}`):new Error(`Invalid move: ${JSON.stringify(L)}`);let u=new DM(this,N);return this._makeMove(N),this._incPositionCount(u.after),u}_push(L){this._history.push({move:L,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(L){let j=this._turn,N=xM(j);if(this._push(L),this._board[L.to]=this._board[L.from],delete this._board[L.from],L.flags&c.EP_CAPTURE&&(this._turn===v?delete this._board[L.to-16]:delete this._board[L.to+16]),L.promotion&&(this._board[L.to]={type:L.promotion,color:j}),this._board[L.to].type===w){if(this._kings[j]=L.to,L.flags&c.KSIDE_CASTLE){let u=L.to-1,I=L.to+1;this._board[u]=this._board[I],delete this._board[I]}else if(L.flags&c.QSIDE_CASTLE){let u=L.to+1,I=L.to-2;this._board[u]=this._board[I],delete this._board[I]}this._castling[j]=0}if(this._castling[j]){for(let u=0,I=q[j].length;u<I;u++)if(L.from===q[j][u].square&&this._castling[j]&q[j][u].flag){this._castling[j]^=q[j][u].flag;break}}if(this._castling[N]){for(let u=0,I=q[N].length;u<I;u++)if(L.to===q[N][u].square&&this._castling[N]&q[N][u].flag){this._castling[N]^=q[N][u].flag;break}}L.flags&c.BIG_PAWN?j===v?this._epSquare=L.to-16:this._epSquare=L.to+16:this._epSquare=f,L.piece===Q?this._halfMoves=0:L.flags&(c.CAPTURE|c.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,j===v&&this._moveNumber++,this._turn=N}undo(){let L=this._undoMove();if(L){let j=new DM(this,L);return this._decPositionCount(j.after),j}return null}_undoMove(){let L=this._history.pop();if(L===void 0)return null;let j=L.move;this._kings=L.kings,this._turn=L.turn,this._castling=L.castling,this._epSquare=L.epSquare,this._halfMoves=L.halfMoves,this._moveNumber=L.moveNumber;let N=this._turn,u=xM(N);if(this._board[j.from]=this._board[j.to],this._board[j.from].type=j.piece,delete this._board[j.to],j.captured)if(j.flags&c.EP_CAPTURE){let I;N===v?I=j.to-16:I=j.to+16,this._board[I]={type:Q,color:u}}else this._board[j.to]={type:j.captured,color:u};if(j.flags&(c.KSIDE_CASTLE|c.QSIDE_CASTLE)){let I,t;j.flags&c.KSIDE_CASTLE?(I=j.to+1,t=j.to-1):(I=j.to-2,t=j.to+1),this._board[I]=this._board[t],delete this._board[t]}return j}pgn({newline:L=`
`,maxWidth:j=0}={}){let N=[],u=!1;for(let D in this._header)N.push("["+D+' "'+this._header[D]+'"]'+L),u=!0;u&&this._history.length&&N.push(L);let I=D=>{let S=this._comments[this.fen()];if(typeof S<"u"){let z=D.length>0?" ":"";D=`${D}${z}{${S}}`}return D},t=[];for(;this._history.length>0;)t.push(this._undoMove());let g=[],i="";for(t.length===0&&g.push(I(""));t.length>0;){i=I(i);let D=t.pop();if(!D)break;if(!this._history.length&&D.color==="b"){let S=`${this._moveNumber}. ...`;i=i?`${i} ${S}`:S}else D.color==="w"&&(i.length&&g.push(i),i=this._moveNumber+".");i=i+" "+this._moveToSan(D,this._moves({legal:!0})),this._makeMove(D)}if(i.length&&g.push(I(i)),typeof this._header.Result<"u"&&g.push(this._header.Result),j===0)return N.join("")+g.join(" ");let y=function(){return N.length>0&&N[N.length-1]===" "?(N.pop(),!0):!1},A=function(D,S){for(let z of S.split(" "))if(z){if(D+z.length>j){for(;y();)D--;N.push(L),D=0}N.push(z),D+=z.length,N.push(" "),D++}return y()&&D--,D},T=0;for(let D=0;D<g.length;D++){if(T+g[D].length>j&&g[D].includes("{")){T=A(T,g[D]);continue}T+g[D].length>j&&D!==0?(N[N.length-1]===" "&&N.pop(),N.push(L),T=0):D!==0&&(N.push(" "),T++),N.push(g[D]),T+=g[D].length}return N.join("")}header(...L){for(let j=0;j<L.length;j+=2)typeof L[j]=="string"&&typeof L[j+1]=="string"&&(this._header[L[j]]=L[j+1]);return this._header}setHeader(L,j){return this._header[L]=j,this._header}removeHeader(L){return L in this._header?(delete this._header[L],!0):!1}getHeaders(){return this._header}loadPgn(L,{strict:j=!1,newlineChar:N=`\r?
`}={}){function u(E){return E.replace(/\\/g,"\\")}function I(E){let U={},Y=E.split(new RegExp(u(N))),NM="",uM="";for(let O=0;O<Y.length;O++){let F=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;NM=Y[O].replace(F,"$1"),uM=Y[O].replace(F,"$2"),NM.trim().length>0&&(U[NM]=uM)}return U}L=L.trim();let g=new RegExp("^(\\[((?:"+u(N)+")|.)*\\])((?:\\s*"+u(N)+"){2}|(?:\\s*"+u(N)+")*$)").exec(L),i=g&&g.length>=2?g[1]:"";this.reset();let y=I(i),A="";for(let E in y)E.toLowerCase()==="fen"&&(A=y[E]),this.header(E,y[E]);if(!j)A&&this.load(A,{preserveHeaders:!0});else if(y.SetUp==="1"){if(!("FEN"in y))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(y.FEN,{preserveHeaders:!0})}function T(E){return Array.from(E).map(function(U){return U.charCodeAt(0)<128?U.charCodeAt(0).toString(16):encodeURIComponent(U).replace(/%/g,"").toLowerCase()}).join("")}function D(E){return E.length==0?"":decodeURIComponent("%"+(E.match(/.{1,2}/g)||[]).join("%"))}let S=function(E){return E=E.replace(new RegExp(u(N),"g")," "),`{${T(E.slice(1,E.length-1))}}`},z=function(E){if(E.startsWith("{")&&E.endsWith("}"))return D(E.slice(1,E.length-1))},e=L.replace(i,"").replace(new RegExp(`({[^}]*})+?|;([^${u(N)}]*)`,"g"),function(E,U,Y){return U!==void 0?S(U):" "+S(`{${Y.slice(1)}}`)}).replace(new RegExp(u(N),"g")," "),n=/(\([^()]+\))+?/g;for(;n.test(e);)e=e.replace(n,"");e=e.replace(/\d+\.(\.\.)?/g,""),e=e.replace(/\.\.\./g,""),e=e.replace(/\$\d+/g,"");let o=e.trim().split(new RegExp(/\s+/));o=o.filter(E=>E!=="");let r="";for(let E=0;E<o.length;E++){let U=z(o[E]);if(U!==void 0){this._comments[this.fen()]=U;continue}let Y=this._moveFromSan(o[E],j);if(Y==null)if(Fj.indexOf(o[E])>-1)r=o[E];else throw new Error(`Invalid move in PGN: ${o[E]}`);else r="",this._makeMove(Y),this._incPositionCount(this.fen())}r&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",r)}_moveToSan(L,j){let N="";if(L.flags&c.KSIDE_CASTLE)N="O-O";else if(L.flags&c.QSIDE_CASTLE)N="O-O-O";else{if(L.piece!==Q){let u=$j(L,j);N+=L.piece.toUpperCase()+u}L.flags&(c.CAPTURE|c.EP_CAPTURE)&&(L.piece===Q&&(N+=d(L.from)[0]),N+="x"),N+=d(L.to),L.promotion&&(N+="="+L.promotion.toUpperCase())}return this._makeMove(L),this.isCheck()&&(this.isCheckmate()?N+="#":N+="+"),this._undoMove(),N}_moveFromSan(L,j=!1){let N=KM(L),u=QL(N),I=this._moves({legal:!0,piece:u});for(let D=0,S=I.length;D<S;D++)if(N===KM(this._moveToSan(I[D],I)))return I[D];if(j)return null;let t,g,i,y,A,T=!1;if(g=N.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),g?(t=g[1],i=g[2],y=g[3],A=g[4],i.length==1&&(T=!0)):(g=N.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),g&&(t=g[1],i=g[2],y=g[3],A=g[4],i.length==1&&(T=!0))),u=QL(N),I=this._moves({legal:!0,piece:t||u}),!y)return null;for(let D=0,S=I.length;D<S;D++)if(i){if((!t||t.toLowerCase()==I[D].piece)&&x[i]==I[D].from&&x[y]==I[D].to&&(!A||A.toLowerCase()==I[D].promotion))return I[D];if(T){let z=d(I[D].from);if((!t||t.toLowerCase()==I[D].piece)&&x[y]==I[D].to&&(i==z[0]||i==z[1])&&(!A||A.toLowerCase()==I[D].promotion))return I[D]}}else if(N===KM(this._moveToSan(I[D],I)).replace("x",""))return I[D];return null}ascii(){let L=`   +------------------------+
`;for(let j=x.a8;j<=x.h1;j++){if(CM(j)===0&&(L+=" "+"87654321"[tM(j)]+" |"),this._board[j]){let N=this._board[j].type,I=this._board[j].color===l?N.toUpperCase():N.toLowerCase();L+=" "+I+" "}else L+=" . ";j+1&136&&(L+=`|
`,j+=8)}return L+=`   +------------------------+
`,L+="     a  b  c  d  e  f  g  h",L}perft(L){let j=this._moves({legal:!1}),N=0,u=this._turn;for(let I=0,t=j.length;I<t;I++)this._makeMove(j[I]),this._isKingAttacked(u)||(L-1>0?N+=this.perft(L-1):N++),this._undoMove();return N}turn(){return this._turn}board(){let L=[],j=[];for(let N=x.a8;N<=x.h1;N++)this._board[N]==null?j.push(null):j.push({square:d(N),type:this._board[N].type,color:this._board[N].color}),N+1&136&&(L.push(j),j=[],N+=8);return L}squareColor(L){if(L in x){let j=x[L];return(tM(j)+CM(j))%2===0?"light":"dark"}return null}history({verbose:L=!1}={}){let j=[],N=[];for(;this._history.length>0;)j.push(this._undoMove());for(;;){let u=j.pop();if(!u)break;L?N.push(new DM(this,u)):N.push(this._moveToSan(u,this._moves())),this._makeMove(u)}return N}_getPositionCount(L){let j=ML(L);return this._positionCount[j]||0}_incPositionCount(L){let j=ML(L);this._positionCount[j]===void 0&&(this._positionCount[j]=0),this._positionCount[j]+=1}_decPositionCount(L){let j=ML(L);this._positionCount[j]===1?delete this._positionCount[j]:this._positionCount[j]-=1}_pruneComments(){let L=[],j={},N=u=>{u in this._comments&&(j[u]=this._comments[u])};for(;this._history.length>0;)L.push(this._undoMove());for(N(this.fen());;){let u=L.pop();if(!u)break;this._makeMove(u),N(this.fen())}this._comments=j}getComment(){return this._comments[this.fen()]}setComment(L){this._comments[this.fen()]=L.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let L=this._comments[this.fen()];return delete this._comments[this.fen()],L}getComments(){return this._pruneComments(),Object.keys(this._comments).map(L=>({fen:L,comment:this._comments[L]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(L=>{let j=this._comments[L];return delete this._comments[L],{fen:L,comment:j}})}setCastlingRights(L,j){for(let u of[w,MM])j[u]!==void 0&&(j[u]?this._castling[L]|=dM[u]:this._castling[L]&=~dM[u]);this._updateCastlingRights();let N=this.getCastlingRights(L);return(j[w]===void 0||j[w]===N[w])&&(j[MM]===void 0||j[MM]===N[MM])}getCastlingRights(L){return{[w]:(this._castling[L]&dM[w])!==0,[MM]:(this._castling[L]&dM[MM])!==0}}moveNumber(){return this._moveNumber}};function mM(M){let L=new TM;for(let j of M)L.move(j);return L.fen()}var dL="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",kL="8/8/8/8/8/8/8/8 w - - 0 1";var mL=["white","black"],gM=["a","b","c","d","e","f","g","h"],SM=["1","2","3","4","5","6","7","8"];var bL=[...SM].reverse(),hM=Array.prototype.concat(...gM.map(M=>SM.map(L=>M+L))),m=M=>hM[8*M[0]+M[1]],C=M=>[M.charCodeAt(0)-97,M.charCodeAt(1)-49];var bM=hM.map(C);function pL(M){let L,j=()=>(L===void 0&&(L=M()),L);return j.clear=()=>{L=void 0},j}var fL=()=>{let M;return{start(){M=performance.now()},cancel(){M=void 0},stop(){if(!M)return 0;let L=performance.now()-M;return M=void 0,L}}},pM=M=>M==="white"?"black":"white",LM=(M,L)=>{let j=M[0]-L[0],N=M[1]-L[1];return j*j+N*N},OM=(M,L)=>M.role===L.role&&M.color===L.color,jM=M=>(L,j)=>[(j?L[0]:7-L[0])*M.width/8,(j?7-L[1]:L[1])*M.height/8],Z=(M,L)=>{M.style.transform=`translate(${L[0]}px,${L[1]}px)`},jL=(M,L,j=1)=>{M.style.transform=`translate(${L[0]}px,${L[1]}px) scale(${j})`},oM=(M,L)=>{M.style.visibility=L?"visible":"hidden"},_=M=>{var L;if(M.clientX||M.clientX===0)return[M.clientX,M.clientY];if(!((L=M.targetTouches)===null||L===void 0)&&L[0])return[M.targetTouches[0].clientX,M.targetTouches[0].clientY]},fM=M=>M.button===2,P=(M,L)=>{let j=document.createElement(M);return L&&(j.className=L),j};function vM(M,L,j){let N=C(M);return L||(N[0]=7-N[0],N[1]=7-N[1]),[j.left+j.width*N[0]/8+j.width/16,j.top+j.height*(7-N[1])/8+j.height/16]}var iM=(M,L)=>Math.abs(M-L),Kj=M=>(L,j,N,u)=>iM(L,N)<2&&(M==="white"?u===j+1||j<=1&&u===j+2&&L===N:u===j-1||j>=6&&u===j-2&&L===N),NL=(M,L,j,N)=>{let u=iM(M,j),I=iM(L,N);return u===1&&I===2||u===2&&I===1},vL=(M,L,j,N)=>iM(M,j)===iM(L,N),ZL=(M,L,j,N)=>M===j||L===N,uL=(M,L,j,N)=>vL(M,L,j,N)||ZL(M,L,j,N),M4=(M,L,j)=>(N,u,I,t)=>iM(N,I)<2&&iM(u,t)<2||j&&u===t&&u===(M==="white"?0:7)&&(N===4&&(I===2&&L.includes(0)||I===6&&L.includes(7))||L.includes(I));function L4(M,L){let j=L==="white"?"1":"8",N=[];for(let[u,I]of M)u[1]===j&&I.color===L&&I.role==="rook"&&N.push(C(u)[0]);return N}function IL(M,L,j){let N=M.get(L);if(!N)return[];let u=C(L),I=N.role,t=I==="pawn"?Kj(N.color):I==="knight"?NL:I==="bishop"?vL:I==="rook"?ZL:I==="queen"?uL:M4(N.color,L4(M,N.color),j);return bM.filter(g=>(u[0]!==g[0]||u[1]!==g[1])&&t(u[0],u[1],g[0],g[1])).map(m)}function b(M,...L){M&&setTimeout(()=>M(...L),1)}function PL(M){M.orientation=pM(M.orientation),M.animation.current=M.draggable.current=M.selected=void 0}function GL(M,L){for(let[j,N]of L)N?M.pieces.set(j,N):M.pieces.delete(j)}function WL(M,L){if(M.check=void 0,L===!0&&(L=M.turnColor),L)for(let[j,N]of M.pieces)N.role==="king"&&N.color===L&&(M.check=j)}function j4(M,L,j,N){W(M),M.premovable.current=[L,j],b(M.premovable.events.set,L,j,N)}function G(M){M.premovable.current&&(M.premovable.current=void 0,b(M.premovable.events.unset))}function N4(M,L,j){G(M),M.predroppable.current={role:L,key:j},b(M.predroppable.events.set,L,j)}function W(M){let L=M.predroppable;L.current&&(L.current=void 0,b(L.events.unset))}function u4(M,L,j){if(!M.autoCastle)return!1;let N=M.pieces.get(L);if(!N||N.role!=="king")return!1;let u=C(L),I=C(j);if(u[1]!==0&&u[1]!==7||u[1]!==I[1])return!1;u[0]===4&&!M.pieces.has(j)&&(I[0]===6?j=m([7,I[1]]):I[0]===2&&(j=m([0,I[1]])));let t=M.pieces.get(j);return!t||t.color!==N.color||t.role!=="rook"?!1:(M.pieces.delete(L),M.pieces.delete(j),u[0]<I[0]?(M.pieces.set(m([6,I[1]]),N),M.pieces.set(m([5,I[1]]),t)):(M.pieces.set(m([2,I[1]]),N),M.pieces.set(m([3,I[1]]),t)),!0)}function tL(M,L,j){let N=M.pieces.get(L),u=M.pieces.get(j);if(L===j||!N)return!1;let I=u&&u.color!==N.color?u:void 0;return j===M.selected&&h(M),b(M.events.move,L,j,I),u4(M,L,j)||(M.pieces.set(j,N),M.pieces.delete(L)),M.lastMove=[L,j],M.check=void 0,b(M.events.change),I||!0}function ZM(M,L,j,N){if(M.pieces.has(j))if(N)M.pieces.delete(j);else return!1;return b(M.events.dropNewPiece,L,j),M.pieces.set(j,L),M.lastMove=[j],M.check=void 0,b(M.events.change),M.movable.dests=void 0,M.turnColor=pM(M.turnColor),!0}function HL(M,L,j){let N=tL(M,L,j);return N&&(M.movable.dests=void 0,M.turnColor=pM(M.turnColor),M.animation.current=void 0),N}function gL(M,L,j){if(GM(M,L,j)){let N=HL(M,L,j);if(N){let u=M.hold.stop();h(M);let I={premove:!1,ctrlKey:M.stats.ctrlKey,holdTime:u};return N!==!0&&(I.captured=N),b(M.movable.events.after,L,j,I),!0}}else if(t4(M,L,j))return j4(M,L,j,{ctrlKey:M.stats.ctrlKey}),h(M),!0;return h(M),!1}function PM(M,L,j,N){let u=M.pieces.get(L);u&&(I4(M,L,j)||N)?(M.pieces.delete(L),ZM(M,u,j,N),b(M.movable.events.afterNewPiece,u.role,j,{premove:!1,predrop:!1})):u&&g4(M,L,j)?N4(M,u.role,j):(G(M),W(M)),M.pieces.delete(L),h(M)}function rM(M,L,j){if(b(M.events.select,L),M.selected){if(M.selected===L&&!M.draggable.enabled){h(M),M.hold.cancel();return}else if((M.selectable.enabled||j)&&M.selected!==L&&gL(M,M.selected,L)){M.stats.dragged=!1;return}}(M.selectable.enabled||M.draggable.enabled)&&(RL(M,L)||yL(M,L))&&(iL(M,L),M.hold.start())}function iL(M,L){M.selected=L,yL(M,L)?M.premovable.customDests||(M.premovable.dests=IL(M.pieces,L,M.premovable.castle)):M.premovable.dests=void 0}function h(M){M.selected=void 0,M.premovable.dests=void 0,M.hold.cancel()}function RL(M,L){let j=M.pieces.get(L);return!!j&&(M.movable.color==="both"||M.movable.color===j.color&&M.turnColor===j.color)}var GM=(M,L,j)=>{var N,u;return L!==j&&RL(M,L)&&(M.movable.free||!!(!((u=(N=M.movable.dests)===null||N===void 0?void 0:N.get(L))===null||u===void 0)&&u.includes(j)))};function I4(M,L,j){let N=M.pieces.get(L);return!!N&&(L===j||!M.pieces.has(j))&&(M.movable.color==="both"||M.movable.color===N.color&&M.turnColor===N.color)}function yL(M,L){let j=M.pieces.get(L);return!!j&&M.premovable.enabled&&M.movable.color===j.color&&M.turnColor!==j.color}function t4(M,L,j){var N,u;let I=(u=(N=M.premovable.customDests)===null||N===void 0?void 0:N.get(L))!==null&&u!==void 0?u:IL(M.pieces,L,M.premovable.castle);return L!==j&&yL(M,L)&&I.includes(j)}function g4(M,L,j){let N=M.pieces.get(L),u=M.pieces.get(j);return!!N&&(!u||u.color!==M.movable.color)&&M.predroppable.enabled&&(N.role!=="pawn"||j[1]!=="1"&&j[1]!=="8")&&M.movable.color===N.color&&M.turnColor!==N.color}function VL(M,L){let j=M.pieces.get(L);return!!j&&M.draggable.enabled&&(M.movable.color==="both"||M.movable.color===j.color&&(M.turnColor===j.color||M.premovable.enabled))}function _L(M){let L=M.premovable.current;if(!L)return!1;let j=L[0],N=L[1],u=!1;if(GM(M,j,N)){let I=HL(M,j,N);if(I){let t={premove:!0};I!==!0&&(t.captured=I),b(M.movable.events.after,j,N,t),u=!0}}return G(M),u}function BL(M,L){let j=M.predroppable.current,N=!1;if(!j)return!1;if(L(j)){let u={role:j.role,color:M.movable.color};ZM(M,u,j.key)&&(b(M.movable.events.afterNewPiece,j.role,j.key,{premove:!1,predrop:!0}),N=!0)}return W(M),N}function aM(M){G(M),W(M),h(M)}function DL(M){M.movable.color=M.movable.dests=M.animation.current=void 0,aM(M)}function H(M,L,j){let N=Math.floor(8*(M[0]-j.left)/j.width);L||(N=7-N);let u=7-Math.floor(8*(M[1]-j.top)/j.height);return L||(u=7-u),N>=0&&N<8&&u>=0&&u<8?m([N,u]):void 0}function JL(M,L,j,N){let u=C(M),I=bM.filter(y=>uL(u[0],u[1],y[0],y[1])||NL(u[0],u[1],y[0],y[1])),g=I.map(y=>vM(m(y),j,N)).map(y=>LM(L,y)),[,i]=g.reduce((y,A,T)=>y[0]<A?y:[A,T],[g[0],0]);return m(I[i])}var a=M=>M.orientation==="white";var SL="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",i4={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},y4={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function WM(M){M==="start"&&(M=SL);let L=new Map,j=7,N=0;for(let u of M)switch(u){case" ":case"[":return L;case"/":if(--j,j<0)return L;N=0;break;case"~":{let I=L.get(m([N-1,j]));I&&(I.promoted=!0);break}default:{let I=u.charCodeAt(0);if(I<57)N+=I-48;else{let t=u.toLowerCase();L.set(m([N,j]),{role:i4[t],color:u===t?"black":"white"}),++N}}}return L}function XL(M){return bL.map(L=>gM.map(j=>{let N=M.get(j+L);if(N){let u=y4[N.role];return N.color==="white"&&(u=u.toUpperCase()),N.promoted&&(u+="~"),u}else return"1"}).join("")).join("/").replace(/1{2,}/g,L=>L.length.toString())}function AL(M,L){L.animation&&(eL(M.animation,L.animation),(M.animation.duration||0)<70&&(M.animation.enabled=!1))}function HM(M,L){var j,N,u;if(!((j=L.movable)===null||j===void 0)&&j.dests&&(M.movable.dests=void 0),!((N=L.drawable)===null||N===void 0)&&N.autoShapes&&(M.drawable.autoShapes=[]),eL(M,L),L.fen&&(M.pieces=WM(L.fen),M.drawable.shapes=((u=L.drawable)===null||u===void 0?void 0:u.shapes)||[]),"check"in L&&WL(M,L.check||!1),"lastMove"in L&&!L.lastMove?M.lastMove=void 0:L.lastMove&&(M.lastMove=L.lastMove),M.selected&&iL(M,M.selected),AL(M,L),!M.movable.rookCastle&&M.movable.dests){let I=M.movable.color==="white"?"1":"8",t="e"+I,g=M.movable.dests.get(t),i=M.pieces.get(t);if(!g||!i||i.role!=="king")return;M.movable.dests.set(t,g.filter(y=>!(y==="a"+I&&g.includes("c"+I))&&!(y==="h"+I&&g.includes("g"+I))))}}function eL(M,L){for(let j in L)Object.prototype.hasOwnProperty.call(L,j)&&(Object.prototype.hasOwnProperty.call(M,j)&&FL(M[j])&&FL(L[j])?eL(M[j],L[j]):M[j]=L[j])}function FL(M){if(typeof M!="object"||M===null)return!1;let L=Object.getPrototypeOf(M);return L===Object.prototype||L===null}var B=(M,L)=>L.animation.enabled?A4(M,L):J(M,L);function J(M,L){let j=M(L);return L.dom.redraw(),j}var zL=(M,L)=>({key:M,pos:C(M),piece:L}),T4=(M,L)=>L.sort((j,N)=>LM(M.pos,j.pos)-LM(M.pos,N.pos))[0];function S4(M,L){let j=new Map,N=[],u=new Map,I=[],t=[],g=new Map,i,y,A;for(let[T,D]of M)g.set(T,zL(T,D));for(let T of hM)i=L.pieces.get(T),y=g.get(T),i?y?OM(i,y.piece)||(I.push(y),t.push(zL(T,i))):t.push(zL(T,i)):y&&I.push(y);for(let T of t)y=T4(T,I.filter(D=>OM(T.piece,D.piece))),y&&(A=[y.pos[0]-T.pos[0],y.pos[1]-T.pos[1]],j.set(T.key,A.concat(A)),N.push(y.key));for(let T of I)N.includes(T.key)||u.set(T.key,T.piece);return{anims:j,fadings:u}}function qL(M,L){let j=M.animation.current;if(j===void 0){M.dom.destroyed||M.dom.redrawNow();return}let N=1-(L-j.start)*j.frequency;if(N<=0)M.animation.current=void 0,M.dom.redrawNow();else{let u=e4(N);for(let I of j.plan.anims.values())I[2]=I[0]*u,I[3]=I[1]*u;M.dom.redrawNow(!0),requestAnimationFrame((I=performance.now())=>qL(M,I))}}function A4(M,L){let j=new Map(L.pieces),N=M(L),u=S4(j,L);if(u.anims.size||u.fadings.size){let I=L.animation.current&&L.animation.current.start;L.animation.current={start:performance.now(),frequency:1/L.animation.duration,plan:u},I||qL(L,performance.now())}else L.dom.redraw();return N}var e4=M=>M<.5?4*M*M*M:(M-1)*(2*M-2)*(2*M-2)+1;var z4=["green","red","blue","yellow"];function $L(M,L){if(L.touches&&L.touches.length>1)return;L.stopPropagation(),L.preventDefault(),L.ctrlKey?h(M):aM(M);let j=_(L),N=H(j,a(M),M.dom.bounds());N&&(M.drawable.current={orig:N,pos:j,brush:c4(L),snapToValidMove:M.drawable.defaultSnapToValidMove},KL(M))}function KL(M){requestAnimationFrame(()=>{let L=M.drawable.current;if(L){let j=H(L.pos,a(M),M.dom.bounds());j||(L.snapToValidMove=!1);let N=L.snapToValidMove?JL(L.orig,L.pos,a(M),M.dom.bounds()):j;N!==L.mouseSq&&(L.mouseSq=N,L.dest=N!==L.orig?N:void 0,M.dom.redrawNow()),KL(M)}})}function Mj(M,L){M.drawable.current&&(M.drawable.current.pos=_(L))}function Lj(M){let L=M.drawable.current;L&&(L.mouseSq&&x4(M.drawable,L),cL(M))}function cL(M){M.drawable.current&&(M.drawable.current=void 0,M.dom.redraw())}function jj(M){M.drawable.shapes.length&&(M.drawable.shapes=[],M.dom.redraw(),Nj(M.drawable))}function c4(M){var L;let j=(M.shiftKey||M.ctrlKey)&&fM(M),N=M.altKey||M.metaKey||((L=M.getModifierState)===null||L===void 0?void 0:L.call(M,"AltGraph"));return z4[(j?1:0)+(N?2:0)]}function x4(M,L){let j=u=>u.orig===L.orig&&u.dest===L.dest,N=M.shapes.find(j);N&&(M.shapes=M.shapes.filter(u=>!j(u))),(!N||N.brush!==L.brush)&&M.shapes.push({orig:L.orig,dest:L.dest,brush:L.brush}),Nj(M)}function Nj(M){M.onChange&&M.onChange(M.shapes)}function uj(M,L){if(!(M.trustAllEvents||L.isTrusted)||L.buttons!==void 0&&L.buttons>1||L.touches&&L.touches.length>1)return;let j=M.dom.bounds(),N=_(L),u=H(N,a(M),j);if(!u)return;let I=M.pieces.get(u),t=M.selected;if(!t&&M.drawable.enabled&&(M.drawable.eraseOnClick||!I||I.color!==M.turnColor)&&jj(M),L.cancelable!==!1&&(!L.touches||M.blockTouchScroll||I||t||C4(M,N)))L.preventDefault();else if(L.touches)return;let g=!!M.premovable.current,i=!!M.predroppable.current;M.stats.ctrlKey=L.ctrlKey,M.selected&&GM(M,M.selected,u)?B(T=>rM(T,u),M):rM(M,u);let y=M.selected===u,A=yj(M,u);if(I&&A&&y&&VL(M,u)){M.draggable.current={orig:u,piece:I,origPos:N,pos:N,started:M.draggable.autoDistance&&M.stats.dragged,element:A,previouslySelected:t,originTarget:L.target,keyHasChanged:!1},A.cgDragging=!0,A.classList.add("dragging");let T=M.dom.elements.ghost;T&&(T.className=`ghost ${I.color} ${I.role}`,Z(T,jM(j)(C(u),a(M))),oM(T,!0)),xL(M)}else g&&G(M),i&&W(M);M.dom.redraw()}function C4(M,L){let j=a(M),N=M.dom.bounds(),u=Math.pow(N.width/8,2);for(let I of M.pieces.keys()){let t=vM(I,j,N);if(LM(t,L)<=u)return!0}return!1}function Ij(M,L,j,N){let u="a0";M.pieces.set(u,L),M.dom.redraw();let I=_(j);M.draggable.current={orig:u,piece:L,origPos:I,pos:I,started:!0,element:()=>yj(M,u),originTarget:j.target,newPiece:!0,force:!!N,keyHasChanged:!1},xL(M)}function xL(M){requestAnimationFrame(()=>{var L;let j=M.draggable.current;if(!j)return;!((L=M.animation.current)===null||L===void 0)&&L.plan.anims.has(j.orig)&&(M.animation.current=void 0);let N=M.pieces.get(j.orig);if(!N||!OM(N,j.piece))yM(M);else if(!j.started&&LM(j.pos,j.origPos)>=Math.pow(M.draggable.distance,2)&&(j.started=!0),j.started){if(typeof j.element=="function"){let I=j.element();if(!I)return;I.cgDragging=!0,I.classList.add("dragging"),j.element=I}let u=M.dom.bounds();Z(j.element,[j.pos[0]-u.left-u.width/16,j.pos[1]-u.top-u.height/16]),j.keyHasChanged||(j.keyHasChanged=j.orig!==H(j.pos,a(M),u))}xL(M)})}function tj(M,L){M.draggable.current&&(!L.touches||L.touches.length<2)&&(M.draggable.current.pos=_(L))}function gj(M,L){let j=M.draggable.current;if(!j)return;if(L.type==="touchend"&&L.cancelable!==!1&&L.preventDefault(),L.type==="touchend"&&j.originTarget!==L.target&&!j.newPiece){M.draggable.current=void 0;return}G(M),W(M);let N=_(L)||j.pos,u=H(N,a(M),M.dom.bounds());u&&j.started&&j.orig!==u?j.newPiece?PM(M,j.orig,u,j.force):(M.stats.ctrlKey=L.ctrlKey,gL(M,j.orig,u)&&(M.stats.dragged=!0)):j.newPiece?M.pieces.delete(j.orig):M.draggable.deleteOnDropOff&&!u&&(M.pieces.delete(j.orig),b(M.events.change)),(j.orig===j.previouslySelected||j.keyHasChanged)&&(j.orig===u||!u)?h(M):M.selectable.enabled||h(M),ij(M),M.draggable.current=void 0,M.dom.redraw()}function yM(M){let L=M.draggable.current;L&&(L.newPiece&&M.pieces.delete(L.orig),M.draggable.current=void 0,h(M),ij(M),M.dom.redraw())}function ij(M){let L=M.dom.elements;L.ghost&&oM(L.ghost,!1)}function yj(M,L){let j=M.dom.elements.board.firstChild;for(;j;){if(j.cgKey===L&&j.tagName==="PIECE")return j;j=j.nextSibling}}function Tj(M,L){M.exploding={stage:1,keys:L},M.dom.redraw(),setTimeout(()=>{Dj(M,2),setTimeout(()=>Dj(M,void 0),120)},120)}function Dj(M,L){M.exploding&&(L?M.exploding.stage=L:M.exploding=void 0,M.dom.redraw())}function Sj(M,L){function j(){PL(M),L()}return{set(N){N.orientation&&N.orientation!==M.orientation&&j(),AL(M,N),(N.fen?B:J)(u=>HM(u,N),M)},state:M,getFen:()=>XL(M.pieces),toggleOrientation:j,setPieces(N){B(u=>GL(u,N),M)},selectSquare(N,u){N?B(I=>rM(I,N,u),M):M.selected&&(h(M),M.dom.redraw())},move(N,u){B(I=>tL(I,N,u),M)},newPiece(N,u){B(I=>ZM(I,N,u),M)},playPremove(){if(M.premovable.current){if(B(_L,M))return!0;M.dom.redraw()}return!1},playPredrop(N){if(M.predroppable.current){let u=BL(M,N);return M.dom.redraw(),u}return!1},cancelPremove(){J(G,M)},cancelPredrop(){J(W,M)},cancelMove(){J(N=>{aM(N),yM(N)},M)},stop(){J(N=>{DL(N),yM(N)},M)},explode(N){Tj(M,N)},setAutoShapes(N){J(u=>u.drawable.autoShapes=N,M)},setShapes(N){J(u=>u.drawable.shapes=N,M)},getKeyAtDomPos(N){return H(N,a(M),M.dom.bounds())},redrawAll:L,dragNewPiece(N,u,I){Ij(M,N,u,I)},destroy(){DL(M),M.dom.unbind&&M.dom.unbind(),M.dom.destroyed=!0}}}function Aj(){return{pieces:WM(SL),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:fL()}}var ej={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function xj(){let M=s("defs"),L=k(s("filter"),{id:"cg-filter-blur"});return L.appendChild(k(s("feGaussianBlur"),{stdDeviation:"0.019"})),M.appendChild(L),M}function Ej(M,L,j){var N;let u=M.drawable,I=u.current,t=I&&I.mouseSq?I:void 0,g=new Map,i=M.dom.bounds(),y=u.autoShapes.filter(S=>!S.piece);for(let S of u.shapes.concat(y).concat(t?[t]:[])){if(!S.dest)continue;let z=(N=g.get(S.dest))!==null&&N!==void 0?N:new Set,e=_M(VM(C(S.orig),M.orientation),i),n=_M(VM(C(S.dest),M.orientation),i);z.add(CL(e,n)),g.set(S.dest,z)}let A=u.shapes.concat(y).map(S=>({shape:S,current:!1,hash:zj(S,EL(S.dest,g),!1,i)}));t&&A.push({shape:t,current:!0,hash:zj(t,EL(t.dest,g),!0,i)});let T=A.map(S=>S.hash).join(";");if(T===M.drawable.prevSvgHash)return;M.drawable.prevSvgHash=T;let D=L.querySelector("defs");o4(u,A,D),n4(A,L.querySelector("g"),j.querySelector("g"),S=>s4(M,S,u.brushes,g,i))}function o4(M,L,j){var N;let u=new Map,I;for(let i of L.filter(y=>y.shape.dest&&y.shape.brush))I=Cj(M.brushes[i.shape.brush],i.shape.modifiers),!((N=i.shape.modifiers)===null||N===void 0)&&N.hilite&&u.set(RM(I).key,RM(I)),u.set(I.key,I);let t=new Set,g=j.firstElementChild;for(;g;)t.add(g.getAttribute("cgKey")),g=g.nextElementSibling;for(let[i,y]of u.entries())t.has(i)||j.appendChild(Q4(y))}function n4(M,L,j,N){let u=new Map;for(let I of M)u.set(I.hash,!1);for(let I of[L,j]){let t=[],g=I.firstElementChild,i;for(;g;)i=g.getAttribute("cgHash"),u.has(i)?u.set(i,!0):t.push(g),g=g.nextElementSibling;for(let y of t)I.removeChild(y)}for(let I of M.filter(t=>!u.get(t.hash)))for(let t of N(I))t.isCustom?j.appendChild(t.el):L.appendChild(t.el)}function zj({orig:M,dest:L,brush:j,piece:N,modifiers:u,customSvg:I,label:t},g,i,y){var A,T;return[y.width,y.height,i,M,L,j,g&&"-",N&&r4(N),u&&a4(u),I&&`custom-${cj(I.html)},${(T=(A=I.center)===null||A===void 0?void 0:A[0])!==null&&T!==void 0?T:"o"}`,t&&`label-${cj(t.text)}`].filter(D=>D).join(",")}function r4(M){return[M.color,M.role,M.scale].filter(L=>L).join(",")}function a4(M){return[M.lineWidth,M.hilite&&"*"].filter(L=>L).join(",")}function cj(M){let L=0;for(let j=0;j<M.length;j++)L=(L<<5)-L+M.charCodeAt(j)>>>0;return L.toString()}function s4(M,{shape:L,current:j,hash:N},u,I,t){var g,i;let y=_M(VM(C(L.orig),M.orientation),t),A=L.dest?_M(VM(C(L.dest),M.orientation),t):y,T=L.brush&&Cj(u[L.brush],L.modifiers),D=I.get(L.dest),S=[];if(T){let z=k(s("g"),{cgHash:N});S.push({el:z}),y[0]!==A[0]||y[1]!==A[1]?z.appendChild(w4(L,T,y,A,j,EL(L.dest,I))):z.appendChild(Y4(u[L.brush],y,j,t))}if(L.label){let z=L.label;(g=z.fill)!==null&&g!==void 0||(z.fill=L.brush&&u[L.brush].color);let e=L.brush?void 0:"tr";S.push({el:U4(z,N,y,A,D,e),isCustom:!0})}if(L.customSvg){let z=(i=L.customSvg.center)!==null&&i!==void 0?i:"orig",[e,n]=z==="label"?oj(y,A,D).map(r=>r-.5):z==="dest"?A:y,o=k(s("g"),{transform:`translate(${e},${n})`,cgHash:N});o.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${L.customSvg.html}</svg>`,S.push({el:o,isCustom:!0})}return S}function Y4(M,L,j,N){let u=l4(),I=(N.width+N.height)/(4*Math.max(N.width,N.height));return k(s("circle"),{stroke:M.color,"stroke-width":u[j?0:1],fill:"none",opacity:Oj(M,j),cx:L[0],cy:L[1],r:I-u[1]/2})}function RM(M){return["#ffffff","#fff","white"].includes(M.color)?ej.hilitePrimary:ej.hiliteWhite}function w4(M,L,j,N,u,I){var t;function g(A){var T;let D=k4(I&&!u),S=N[0]-j[0],z=N[1]-j[1],e=Math.atan2(z,S),n=Math.cos(e)*D,o=Math.sin(e)*D;return k(s("line"),{stroke:A?RM(L).color:L.color,"stroke-width":d4(L,u)+(A?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${A?RM(L).key:L.key})`,opacity:!((T=M.modifiers)===null||T===void 0)&&T.hilite?1:Oj(L,u),x1:j[0],y1:j[1],x2:N[0]-n,y2:N[1]-o})}if(!(!((t=M.modifiers)===null||t===void 0)&&t.hilite))return g(!1);let i=s("g"),y=k(s("g"),{filter:"url(#cg-filter-blur)"});return y.appendChild(m4(j,N)),y.appendChild(g(!0)),i.appendChild(y),i.appendChild(g(!1)),i}function Q4(M){let L=k(s("marker"),{id:"arrowhead-"+M.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:M.key.startsWith("hilite")?1.86:2.05,refY:2});return L.appendChild(k(s("path"),{d:"M0,0 V4 L3,2 Z",fill:M.color})),L.setAttribute("cgKey",M.key),L}function U4(M,L,j,N,u,I){var t;let i=.4*.75**M.text.length,y=oj(j,N,u),A=I==="tr"?.4:0,T=k(s("g"),{transform:`translate(${y[0]+A},${y[1]-A})`,cgHash:L});T.appendChild(k(s("circle"),{r:.4/2,"fill-opacity":I?1:.8,"stroke-opacity":I?1:.7,"stroke-width":.03,fill:(t=M.fill)!==null&&t!==void 0?t:"#666",stroke:"white"}));let D=k(s("text"),{"font-size":i,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**M.text.length});return D.innerHTML=M.text,T.appendChild(D),T}function VM(M,L){return L==="white"?M:[7-M[0],7-M[1]]}function EL(M,L){return(M&&L.has(M)&&L.get(M).size>1)===!0}function s(M){return document.createElementNS("http://www.w3.org/2000/svg",M)}function k(M,L){for(let j in L)Object.prototype.hasOwnProperty.call(L,j)&&M.setAttribute(j,L[j]);return M}function Cj(M,L){return L?{color:M.color,opacity:Math.round(M.opacity*10)/10,lineWidth:Math.round(L.lineWidth||M.lineWidth),key:[M.key,L.lineWidth].filter(j=>j).join("")}:M}function l4(){return[3/64,4/64]}function d4(M,L){return(M.lineWidth||10)*(L?.85:1)/64}function Oj(M,L){return(M.opacity||1)*(L?.9:1)}function k4(M){return(M?20:10)/64}function _M(M,L){let j=Math.min(1,L.width/L.height),N=Math.min(1,L.height/L.width);return[(M[0]-3.5)*j,(3.5-M[1])*N]}function m4(M,L){let j={from:[Math.floor(Math.min(M[0],L[0])),Math.floor(Math.min(M[1],L[1]))],to:[Math.ceil(Math.max(M[0],L[0])),Math.ceil(Math.max(M[1],L[1]))]};return k(s("rect"),{x:j.from[0],y:j.from[1],width:j.to[0]-j.from[0],height:j.to[1]-j.from[1],fill:"none",stroke:"none"})}function CL(M,L,j=!0){let N=Math.atan2(L[1]-M[1],L[0]-M[0])+Math.PI;return j?(Math.round(N*8/Math.PI)+16)%16:N}function h4(M,L){return Math.sqrt([M[0]-L[0],M[1]-L[1]].reduce((j,N)=>j+N*N,0))}function oj(M,L,j){let N=h4(M,L),u=CL(M,L,!1);if(j&&(N-=33/64,j.size>1)){N-=10/64;let I=CL(M,L);(j.has((I+1)%16)||j.has((I+15)%16))&&I&1&&(N-=.4)}return[M[0]-Math.cos(u)*N,M[1]-Math.sin(u)*N].map(I=>I+.5)}function nj(M,L){M.innerHTML="",M.classList.add("cg-wrap");for(let i of mL)M.classList.toggle("orientation-"+i,L.orientation===i);M.classList.toggle("manipulable",!L.viewOnly);let j=P("cg-container");M.appendChild(j);let N=P("cg-board");j.appendChild(N);let u,I,t;if(L.drawable.visible&&(u=k(s("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),u.appendChild(xj()),u.appendChild(s("g")),I=k(s("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),I.appendChild(s("g")),t=P("cg-auto-pieces"),j.appendChild(u),j.appendChild(I),j.appendChild(t)),L.coordinates){let i=L.orientation==="black"?" black":"",y=L.ranksPosition==="left"?" left":"";if(L.coordinatesOnSquares){let A=L.orientation==="white"?T=>T+1:T=>8-T;gM.forEach((T,D)=>j.appendChild(OL(SM.map(S=>T+S),"squares rank"+A(D)+i+y)))}else j.appendChild(OL(SM,"ranks"+i+y)),j.appendChild(OL(gM,"files"+i))}let g;return L.draggable.enabled&&L.draggable.showGhost&&(g=P("piece","ghost"),oM(g,!1),j.appendChild(g)),{board:N,container:j,wrap:M,ghost:g,svg:u,customSvg:I,autoPieces:t}}function OL(M,L){let j=P("coords",L),N;for(let u of M)N=P("coord"),N.textContent=u,j.appendChild(N);return j}function rj(M,L){if(!M.dropmode.active)return;G(M),W(M);let j=M.dropmode.piece;if(j){M.pieces.set("a0",j);let N=_(L),u=N&&H(N,a(M),M.dom.bounds());u&&PM(M,"a0",u)}M.dom.redraw()}function sj(M,L){let j=M.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(L).observe(M.dom.elements.wrap),(M.disableContextMenu||M.drawable.enabled)&&j.addEventListener("contextmenu",u=>u.preventDefault()),M.viewOnly)return;let N=p4(M);j.addEventListener("touchstart",N,{passive:!1}),j.addEventListener("mousedown",N,{passive:!1})}function Yj(M,L){let j=[];if("ResizeObserver"in window||j.push(sM(document.body,"chessground.resize",L)),!M.viewOnly){let N=aj(M,tj,Mj),u=aj(M,gj,Lj);for(let t of["touchmove","mousemove"])j.push(sM(document,t,N));for(let t of["touchend","mouseup"])j.push(sM(document,t,u));let I=()=>M.dom.bounds.clear();j.push(sM(document,"scroll",I,{capture:!0,passive:!0})),j.push(sM(window,"resize",I,{passive:!0}))}return()=>j.forEach(N=>N())}function sM(M,L,j,N){return M.addEventListener(L,j,N),()=>M.removeEventListener(L,j,N)}var p4=M=>L=>{M.draggable.current?yM(M):M.drawable.current?cL(M):L.shiftKey||fM(L)?M.drawable.enabled&&$L(M,L):M.viewOnly||(M.dropmode.active?rj(M,L):uj(M,L))},aj=(M,L,j)=>N=>{M.drawable.current?M.drawable.enabled&&j(M,N):M.viewOnly||L(M,N)};function Qj(M){let L=a(M),j=jM(M.dom.bounds()),N=M.dom.elements.board,u=M.pieces,I=M.animation.current,t=I?I.plan.anims:new Map,g=I?I.plan.fadings:new Map,i=M.draggable.current,y=v4(M),A=new Set,T=new Set,D=new Map,S=new Map,z,e,n,o,r,E,U,Y,NM,uM;for(e=N.firstChild;e;){if(z=e.cgKey,lj(e))if(n=u.get(z),r=t.get(z),E=g.get(z),o=e.cgPiece,e.cgDragging&&(!i||i.orig!==z)&&(e.classList.remove("dragging"),Z(e,j(C(z),L)),e.cgDragging=!1),!E&&e.cgFading&&(e.cgFading=!1,e.classList.remove("fading")),n){if(r&&e.cgAnimating&&o===YM(n)){let O=C(z);O[0]+=r[2],O[1]+=r[3],e.classList.add("anim"),Z(e,j(O,L))}else e.cgAnimating&&(e.cgAnimating=!1,e.classList.remove("anim"),Z(e,j(C(z),L)),M.addPieceZIndex&&(e.style.zIndex=oL(C(z),L)));o===YM(n)&&(!E||!e.cgFading)?A.add(z):E&&o===YM(E)?(e.classList.add("fading"),e.cgFading=!0):nL(D,o,e)}else nL(D,o,e);else if(dj(e)){let O=e.className;y.get(z)===O?T.add(z):nL(S,O,e)}e=e.nextSibling}for(let[O,F]of y)if(!T.has(O)){NM=S.get(F),uM=NM&&NM.pop();let R=j(C(O),L);if(uM)uM.cgKey=O,Z(uM,R);else{let V=P("square",F);V.cgKey=O,Z(V,R),N.insertBefore(V,N.firstChild)}}for(let[O,F]of u)if(r=t.get(O),!A.has(O))if(U=D.get(YM(F)),Y=U&&U.pop(),Y){Y.cgKey=O,Y.cgFading&&(Y.classList.remove("fading"),Y.cgFading=!1);let R=C(O);M.addPieceZIndex&&(Y.style.zIndex=oL(R,L)),r&&(Y.cgAnimating=!0,Y.classList.add("anim"),R[0]+=r[2],R[1]+=r[3]),Z(Y,j(R,L))}else{let R=YM(F),V=P("piece",R),UM=C(O);V.cgPiece=R,V.cgKey=O,r&&(V.cgAnimating=!0,UM[0]+=r[2],UM[1]+=r[3]),Z(V,j(UM,L)),M.addPieceZIndex&&(V.style.zIndex=oL(UM,L)),N.appendChild(V)}for(let O of D.values())wj(M,O);for(let O of S.values())wj(M,O)}function Uj(M){let L=a(M),j=jM(M.dom.bounds()),N=M.dom.elements.board.firstChild;for(;N;)(lj(N)&&!N.cgAnimating||dj(N))&&Z(N,j(C(N.cgKey),L)),N=N.nextSibling}function rL(M){var L,j;let N=M.dom.elements.wrap.getBoundingClientRect(),u=M.dom.elements.container,I=N.height/N.width,t=Math.floor(N.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,g=t*I;u.style.width=t+"px",u.style.height=g+"px",M.dom.bounds.clear(),(L=M.addDimensionsCssVarsTo)===null||L===void 0||L.style.setProperty("---cg-width",t+"px"),(j=M.addDimensionsCssVarsTo)===null||j===void 0||j.style.setProperty("---cg-height",g+"px")}var lj=M=>M.tagName==="PIECE",dj=M=>M.tagName==="SQUARE";function wj(M,L){for(let j of L)M.dom.elements.board.removeChild(j)}function oL(M,L){let N=M[1];return`${L?10-N:3+N}`}var YM=M=>`${M.color} ${M.role}`;function v4(M){var L,j,N;let u=new Map;if(M.lastMove&&M.highlight.lastMove)for(let g of M.lastMove)X(u,g,"last-move");if(M.check&&M.highlight.check&&X(u,M.check,"check"),M.selected&&(X(u,M.selected,"selected"),M.movable.showDests)){let g=(L=M.movable.dests)===null||L===void 0?void 0:L.get(M.selected);if(g)for(let y of g)X(u,y,"move-dest"+(M.pieces.has(y)?" oc":""));let i=(N=(j=M.premovable.customDests)===null||j===void 0?void 0:j.get(M.selected))!==null&&N!==void 0?N:M.premovable.dests;if(i)for(let y of i)X(u,y,"premove-dest"+(M.pieces.has(y)?" oc":""))}let I=M.premovable.current;if(I)for(let g of I)X(u,g,"current-premove");else M.predroppable.current&&X(u,M.predroppable.current.key,"current-premove");let t=M.exploding;if(t)for(let g of t.keys)X(u,g,"exploding"+t.stage);return M.highlight.custom&&M.highlight.custom.forEach((g,i)=>{X(u,i,g)}),u}function X(M,L,j){let N=M.get(L);N?M.set(L,`${N} ${j}`):M.set(L,j)}function nL(M,L,j){let N=M.get(L);N?N.push(j):M.set(L,[j])}function kj(M,L,j){let N=new Map,u=[];for(let g of M)N.set(g.hash,!1);let I=L.firstElementChild,t;for(;I;)t=I.getAttribute("cgHash"),N.has(t)?N.set(t,!0):u.push(I),I=I.nextElementSibling;for(let g of u)L.removeChild(g);for(let g of M)N.get(g.hash)||L.appendChild(j(g))}function mj(M,L){let N=M.drawable.autoShapes.filter(u=>u.piece).map(u=>({shape:u,hash:P4(u),current:!1}));kj(N,L,u=>Z4(M,u,M.dom.bounds()))}function hj(M){var L;let j=a(M),N=jM(M.dom.bounds()),u=(L=M.dom.elements.autoPieces)===null||L===void 0?void 0:L.firstChild;for(;u;)jL(u,N(C(u.cgKey),j),u.cgScale),u=u.nextSibling}function Z4(M,{shape:L,hash:j},N){var u,I,t;let g=L.orig,i=(u=L.piece)===null||u===void 0?void 0:u.role,y=(I=L.piece)===null||I===void 0?void 0:I.color,A=(t=L.piece)===null||t===void 0?void 0:t.scale,T=P("piece",`${i} ${y}`);return T.setAttribute("cgHash",j),T.cgKey=g,T.cgScale=A,jL(T,jM(N)(C(g),a(M)),A),T}var P4=M=>{var L,j,N;return[M.orig,(L=M.piece)===null||L===void 0?void 0:L.role,(j=M.piece)===null||j===void 0?void 0:j.color,(N=M.piece)===null||N===void 0?void 0:N.scale].join(",")};function bj(M,L){let j=Aj();HM(j,L||{});function N(){let u="dom"in j?j.dom.unbind:void 0,I=nj(M,j),t=pL(()=>I.board.getBoundingClientRect()),g=A=>{Qj(y),I.autoPieces&&mj(y,I.autoPieces),!A&&I.svg&&Ej(y,I.svg,I.customSvg)},i=()=>{rL(y),Uj(y),I.autoPieces&&hj(y)},y=j;return y.dom={elements:I,bounds:t,redraw:W4(g),redrawNow:g,unbind:u},y.drawable.prevSvgHash="",rL(y),g(!1),sj(y,i),u||(y.dom.unbind=Yj(y,i)),y.events.insert&&y.events.insert(I),y}return Sj(N(),N)}function W4(M){let L=!1;return()=>{L||(L=!0,requestAnimationFrame(()=>{M(),L=!1}))}}var BM=class{moveEventListeners=[];constructor(L){this.board=new TM,this.cg=bj(document.getElementById(L),{draggable:{enabled:fj()},selectable:{enabled:vj()},animation:{enabled:!1},premovable:{enabled:!1}}),p.onchange("movement",N=>{this.cg.set({draggable:{enabled:fj()},selectable:{enabled:vj()}})});let j=N=>{let u=cM.map(({name:I})=>I);$(`#${L}`).removeClass(u).addClass(N)};p.onchange("boardStyle",j),j(p.get("boardStyle"))}toggleOrientation(){this.cg.toggleOrientation()}resetToFEN(L,j="keep"){let N=(u,I)=>{let t=this.board.move({from:u,to:I,promotion:"q"});this.cg.set({fen:this.board.fen(),turnColor:wM(this.board),check:this.board.inCheck(),movable:{color:wM(this.board),dests:pj(this.board)}});for(let g of this.moveEventListeners)g(t)};if(this.board.load(L,{skipValidation:!0}),this.cg.cancelMove(),this.cg.cancelPremove(),j==="keep")j=this.cg.state.orientation;else if(j==="auto")j=wM(this.board);else if(!["white","black"].includes(j))throw new Error("invalid orientation specified");this.cg.set({fen:L,orientation:j,lastMove:void 0,check:this.board.inCheck(),turnColor:wM(this.board),movable:{free:!1,dests:pj(this.board),color:wM(this.board),events:{after:N}}})}addMoveEventListener(L){this.moveEventListeners.push(L)}};function wM(M){return M.turn()==="w"?"white":"black"}function pj(M){let L=new Map;return UL.forEach(j=>{let N=M.moves({square:j,verbose:!0});N.length&&L.set(j,N.map(u=>u.to))}),L}function fj(){return["drag","both"].includes(p.get("movement"))}function vj(){return["click","both"].includes(p.get("movement"))}var JM=class{moves=[];curMoveIndex=0;moveEventListeners=[];constructor(L){this.$tableElem=$(`#${L}`)}reset(L=[]){this.moves=L,this.curMoveIndex=0,this.render()}#M(){for(let L of this.moveEventListeners)L(this.curMoveIndex)}render(){let L=j=>{let N=this.curMoveIndex;this.setCurrentMove(j),N!==this.curMoveIndex&&this.#M()};this.$tableElem.empty();for(let j=0;j<this.moves.length;j+=2){let N=$("<tr></tr>");N.append(`<th>${j/2+1}</th>`),N.append($(`<td>${this.moves[j]}</td>`).click(()=>{L(j)})),this.moves[j+1]&&N.append($(`<td>${this.moves[j+1]}</td>`).click(()=>{L(j+1)})),this.$tableElem.append(N)}this.setCurrentMove(this.curMoveIndex)}constrainMoveIndex(L){return L<0||this.moves.length===0?0:L>=this.moves.length?this.moves.length-1:L}getCurrentMoveIndex(){return this.curMoveIndex}setCurrentMove(L){L=this.constrainMoveIndex(L),this.$tableElem.find("td").removeClass("active"),this.$tableElem.find(`tr:nth-child(${Math.floor(L/2)+1}) td:nth-of-type(${L%2+1})`).addClass("active"),this.curMoveIndex=L}focusTop(L){if(this.moves.length===0)return;L=this.constrainMoveIndex(L);let j=this.$tableElem.parent(),u=this.$tableElem.find("td").eq(L).position().top;j.get(0).scrollTo(0,u)}focusBottom(L){if(this.moves.length===0)return;L=this.constrainMoveIndex(L);let j=this.$tableElem.parent(),N=this.$tableElem.find("td").eq(L),u=N.position().top+N.height();j.get(0).scrollTo(0,u-j.height())}isFullyVisible(L){if(this.moves.length===0)return!0;L=this.constrainMoveIndex(L);let j=this.$tableElem.parent(),N=j.get(0),u=this.$tableElem.find("td").eq(L),I=u.position().top,t=u.position().top+u.height();return I>=N.scrollTop&&t<=N.scrollTop+j.height()}gotoNextMove(){this.setCurrentMove(this.curMoveIndex+1),this.isFullyVisible(this.curMoveIndex)||this.focusBottom(this.curMoveIndex),this.#M()}gotoPrevMove(){this.setCurrentMove(this.curMoveIndex-1),this.isFullyVisible(this.curMoveIndex)||this.focusTop(this.curMoveIndex),this.#M()}gotoFirstMove(){this.setCurrentMove(0),this.focusBottom(this.curMoveIndex),this.#M()}gotoLastMove(){this.setCurrentMove(this.moves.length-1),this.focusBottom(this.curMoveIndex),this.#M()}pushMove(L){this.moves=this.moves.slice(0,this.curMoveIndex+1),this.moves.push(L),this.curMoveIndex+=1,this.render(),this.focusBottom(this.curMoveIndex)}getCurrentFEN(){return mM(this.moves.slice(0,this.curMoveIndex+1))}addMoveEventListener(L){this.moveEventListeners.push(L)}};var H4=new URLSearchParams(document.location.search),Zj=H4.get("FEN"),AM=document.getElementById("fen-input"),eu=document.getElementById("fen-copy");function aL(){return AM.value||AM.placeholder}function Pj(M,L="success"){$("#alert-box").append(`
    <div class="alert alert-${L} text-center fw-bold mb-0" role="alert">
      ${M}
    </div>
  `)}function QM(){$("#alert-box").empty()}$(document).ready(()=>{let M=new BM("main-board"),L=new JM("main-pgn-table"),j=u=>{QM(),$(AM).val(u),M.resetToFEN(u),L.reset()},N=u=>{QM();let I=mM(u);$(AM).val(I),M.resetToFEN(I,"auto");let t=M.board.turn()==="w"?"White":"Black";Pj(`${t} to move and win!`,"info"),L.reset(u),L.setCurrentMove(u.length-1),L.focusBottom(u.length-1)};$("#btn-starting-position").click(()=>{j(dL)}),$("#btn-clear-board").click(()=>{j(kL)}),$("#btn-random-puzzle").click(function(){QM();let u=$(this).text(),I=!1;setTimeout(()=>{I||$(this).html('<span class="spinner-border spinner-border-sm" aria-hidden="true"></span> Loading...')},500),$.getJSON("https://lichess.org/api/puzzle/next?angle=mate",g=>{I=!0,$(this).text(u),console.log("puzzle data",g);let i=g.game.pgn.split(" ");N(i)})}),$("#fen-copy").click(()=>{navigator.clipboard.writeText(aL())}),$("#fen-input").on("input",()=>{j(aL())}),L.addMoveEventListener(()=>{let u=L.getCurrentFEN();M.resetToFEN(u),$(AM).val(u),QM()}),M.addMoveEventListener(u=>{L.pushMove(u.san),$(AM).val(M.board.FEN),QM(),M.board.isCheckmate()&&Pj("Checkmate!","success")}),document.addEventListener("keydown",u=>{u.code==="ArrowRight"?L.gotoNextMove():u.code==="ArrowLeft"?L.gotoPrevMove():u.code==="ArrowUp"?L.gotoFirstMove():u.code==="ArrowDown"?L.gotoLastMove():u.code==="KeyF"&&M.toggleOrientation()}),j(Zj||aL())});})();
/*! Bundled license information:

chess.js/dist/esm/chess.js:
  (**
   * @license
   * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
   * All rights reserved.
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are met:
   *
   * 1. Redistributions of source code must retain the above copyright notice,
   *    this list of conditions and the following disclaimer.
   * 2. Redistributions in binary form must reproduce the above copyright notice,
   *    this list of conditions and the following disclaimer in the documentation
   *    and/or other materials provided with the distribution.
   *
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
   * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
   * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
   * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
   * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
   * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
   * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
   * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
   * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
   * POSSIBILITY OF SUCH DAMAGE.
   *)
*/
//# sourceMappingURL=main.js.map
