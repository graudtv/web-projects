(()=>{var l="w",f="b",Q="p",BM="n",sM="b",zM="r",K="q",w="k",HM="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",iM=class{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(L,j){let{color:N,piece:u,from:I,to:t,flags:g,captured:y,promotion:i}=j,A=d(I),T=d(t);this.color=N,this.piece=u,this.from=A,this.to=T,this.san=L._moveToSan(j,L._moves({legal:!0})),this.lan=A+T,this.before=L.fen(),L._makeMove(j),this.after=L.fen(),L._undoMove(),this.flags="";for(let D in x)x[D]&g&&(this.flags+=uM[D]);y&&(this.captured=y),i&&(this.promotion=i,this.lan+=i)}isCapture(){return this.flags.indexOf(uM.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(uM.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(uM.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(uM.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(uM.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(uM.BIG_PAWN)>-1}},b=-1,uM={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},OL=["a8","b8","c8","d8","e8","f8","g8","h8","a7","b7","c7","d7","e7","f7","g7","h7","a6","b6","c6","d6","e6","f6","g6","h6","a5","b5","c5","d5","e5","f5","g5","h5","a4","b4","c4","d4","e4","f4","g4","h4","a3","b3","c3","d3","e3","f3","g3","h3","a2","b2","c2","d2","e2","f2","g2","h2","a1","b1","c1","d1","e1","f1","g1","h1"],x={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},c={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},RM={b:[16,32,17,15],w:[-16,-32,-17,-15]},cL={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Uj=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],lj=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],dj={p:1,n:2,b:4,r:8,q:16,k:32},kj="pnbrqkPNBRQK",EL=[BM,sM,zM,K],mj=7,hj=6,pj=1,bj=0,aM={[w]:x.KSIDE_CASTLE,[K]:x.QSIDE_CASTLE},F={w:[{square:c.a1,flag:x.QSIDE_CASTLE},{square:c.h1,flag:x.KSIDE_CASTLE}],b:[{square:c.a8,flag:x.QSIDE_CASTLE},{square:c.h8,flag:x.KSIDE_CASTLE}]},fj={b:pj,w:hj},Zj=["1-0","0-1","1/2-1/2","*"];function IM(M){return M>>4}function eM(M){return M&15}function oL(M){return"0123456789".indexOf(M)!==-1}function d(M){let L=eM(M),j=IM(M);return"abcdefgh".substring(L,L+1)+"87654321".substring(j,j+1)}function AM(M){return M===l?f:l}function vj(M){let L=M.split(/\s+/);if(L.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let j=parseInt(L[5],10);if(isNaN(j)||j<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let N=parseInt(L[4],10);if(isNaN(N)||N<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(L[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(L[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(L[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let u=L[0].split("/");if(u.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let t=0;t<u.length;t++){let g=0,y=!1;for(let i=0;i<u[t].length;i++)if(oL(u[t][i])){if(y)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};g+=parseInt(u[t][i],10),y=!0}else{if(!/^[prnbqkPRNBQK]$/.test(u[t][i]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};g+=1,y=!1}if(g!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(L[3][1]=="3"&&L[1]=="w"||L[3][1]=="6"&&L[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let I=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:t,regex:g}of I){if(!g.test(L[0]))return{ok:!1,error:`Invalid FEN: missing ${t} king`};if((L[0].match(g)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${t} kings`}}return Array.from(u[0]+u[7]).some(t=>t.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Pj(M,L){let j=M.from,N=M.to,u=M.piece,I=0,t=0,g=0;for(let y=0,i=L.length;y<i;y++){let A=L[y].from,T=L[y].to,D=L[y].piece;u===D&&j!==A&&N===T&&(I++,IM(j)===IM(A)&&t++,eM(j)===eM(A)&&g++)}return I>0?t>0&&g>0?d(j):g>0?d(j).charAt(1):d(j).charAt(0):""}function q(M,L,j,N,u,I=void 0,t=x.NORMAL){let g=IM(N);if(u===Q&&(g===mj||g===bj))for(let y=0;y<EL.length;y++){let i=EL[y];M.push({color:L,from:j,to:N,piece:u,captured:I,promotion:i,flags:t|x.PROMOTION})}else M.push({color:L,from:j,to:N,piece:u,captured:I,flags:t})}function CL(M){let L=M.charAt(0);return L>="a"&&L<="h"?M.match(/[a-h]\d.*[a-h]\d/)?void 0:Q:(L=L.toLowerCase(),L==="o"?w:L)}function VM(M){return M.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function _M(M){return M.split(" ").slice(0,4).join(" ")}var DM=class{_board=new Array(128);_turn=l;_header={};_kings={w:b,b};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_positionCount={};constructor(L=HM,{skipValidation:j=!1}={}){this.load(L,{skipValidation:j})}clear({preserveHeaders:L=!1}={}){this._board=new Array(128),this._kings={w:b,b},this._turn=l,this._castling={w:0,b:0},this._epSquare=b,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=L?this._header:{},this._positionCount={},delete this._header.SetUp,delete this._header.FEN}load(L,{skipValidation:j=!1,preserveHeaders:N=!1}={}){let u=L.split(/\s+/);if(u.length>=2&&u.length<6){let g=["-","-","0","1"];L=u.concat(g.slice(-(6-u.length))).join(" ")}if(u=L.split(/\s+/),!j){let{ok:g,error:y}=vj(L);if(!g)throw new Error(y)}let I=u[0],t=0;this.clear({preserveHeaders:N});for(let g=0;g<I.length;g++){let y=I.charAt(g);if(y==="/")t+=8;else if(oL(y))t+=parseInt(y,10);else{let i=y<"a"?l:f;this._put({type:y.toLowerCase(),color:i},d(t)),t++}}this._turn=u[1],u[2].indexOf("K")>-1&&(this._castling.w|=x.KSIDE_CASTLE),u[2].indexOf("Q")>-1&&(this._castling.w|=x.QSIDE_CASTLE),u[2].indexOf("k")>-1&&(this._castling.b|=x.KSIDE_CASTLE),u[2].indexOf("q")>-1&&(this._castling.b|=x.QSIDE_CASTLE),this._epSquare=u[3]==="-"?b:c[u[3]],this._halfMoves=parseInt(u[4],10),this._moveNumber=parseInt(u[5],10),this._updateSetup(L),this._incPositionCount(L)}fen(){let L=0,j="";for(let I=c.a8;I<=c.h1;I++){if(this._board[I]){L>0&&(j+=L,L=0);let{color:t,type:g}=this._board[I];j+=t===l?g.toUpperCase():g.toLowerCase()}else L++;I+1&136&&(L>0&&(j+=L),I!==c.h1&&(j+="/"),L=0,I+=8)}let N="";this._castling[l]&x.KSIDE_CASTLE&&(N+="K"),this._castling[l]&x.QSIDE_CASTLE&&(N+="Q"),this._castling[f]&x.KSIDE_CASTLE&&(N+="k"),this._castling[f]&x.QSIDE_CASTLE&&(N+="q"),N=N||"-";let u="-";if(this._epSquare!==b){let I=this._epSquare+(this._turn===l?16:-16),t=[I+1,I-1];for(let g of t){if(g&136)continue;let y=this._turn;if(this._board[g]?.color===y&&this._board[g]?.type===Q){this._makeMove({color:y,from:g,to:this._epSquare,piece:Q,captured:Q,flags:x.EP_CAPTURE});let i=!this._isKingAttacked(y);if(this._undoMove(),i){u=d(this._epSquare);break}}}}return[j,this._turn,N,u,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(L){this._history.length>0||(L!==HM?(this._header.SetUp="1",this._header.FEN=L):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(HM)}get(L){return this._board[c[L]]}put({type:L,color:j},N){return this._put({type:L,color:j},N)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_put({type:L,color:j},N){if(kj.indexOf(L.toLowerCase())===-1||!(N in c))return!1;let u=c[N];if(L==w&&!(this._kings[j]==b||this._kings[j]==u))return!1;let I=this._board[u];return I&&I.type===w&&(this._kings[I.color]=b),this._board[u]={type:L,color:j},L===w&&(this._kings[j]=u),!0}remove(L){let j=this.get(L);return delete this._board[c[L]],j&&j.type===w&&(this._kings[j.color]=b),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),j}_updateCastlingRights(){let L=this._board[c.e1]?.type===w&&this._board[c.e1]?.color===l,j=this._board[c.e8]?.type===w&&this._board[c.e8]?.color===f;(!L||this._board[c.a1]?.type!==zM||this._board[c.a1]?.color!==l)&&(this._castling.w&=~x.QSIDE_CASTLE),(!L||this._board[c.h1]?.type!==zM||this._board[c.h1]?.color!==l)&&(this._castling.w&=~x.KSIDE_CASTLE),(!j||this._board[c.a8]?.type!==zM||this._board[c.a8]?.color!==f)&&(this._castling.b&=~x.QSIDE_CASTLE),(!j||this._board[c.h8]?.type!==zM||this._board[c.h8]?.color!==f)&&(this._castling.b&=~x.KSIDE_CASTLE)}_updateEnPassantSquare(){if(this._epSquare===b)return;let L=this._epSquare+(this._turn===l?-16:16),j=this._epSquare+(this._turn===l?16:-16),N=[j+1,j-1];if(this._board[L]!==null||this._board[this._epSquare]!==null||this._board[j]?.color!==AM(this._turn)||this._board[j]?.type!==Q){this._epSquare=b;return}let u=I=>!(I&136)&&this._board[I]?.color===this._turn&&this._board[I]?.type===Q;N.some(u)||(this._epSquare=b)}_attacked(L,j,N){let u=[];for(let I=c.a8;I<=c.h1;I++){if(I&136){I+=7;continue}if(this._board[I]===void 0||this._board[I].color!==L)continue;let t=this._board[I],g=I-j;if(g===0)continue;let y=g+119;if(Uj[y]&dj[t.type]){if(t.type===Q){if(g>0&&t.color===l||g<=0&&t.color===f)if(N)u.push(d(I));else return!0;continue}if(t.type==="n"||t.type==="k")if(N){u.push(d(I));continue}else return!0;let i=lj[y],A=I+i,T=!1;for(;A!==j;){if(this._board[A]!=null){T=!0;break}A+=i}if(!T)if(N){u.push(d(I));continue}else return!0}}return N?u:!1}attackers(L,j){return j?this._attacked(j,c[L],!0):this._attacked(this._turn,c[L],!0)}_isKingAttacked(L){let j=this._kings[L];return j===-1?!1:this._attacked(AM(L),j)}isAttacked(L,j){return this._attacked(j,c[L])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let L={b:0,n:0,r:0,q:0,k:0,p:0},j=[],N=0,u=0;for(let I=c.a8;I<=c.h1;I++){if(u=(u+1)%2,I&136){I+=7;continue}let t=this._board[I];t&&(L[t.type]=t.type in L?L[t.type]+1:1,t.type===sM&&j.push(u),N++)}if(N===2)return!0;if(N===3&&(L[sM]===1||L[BM]===1))return!0;if(N===L[sM]+2){let I=0,t=j.length;for(let g=0;g<t;g++)I+=j[g];if(I===0||I===t)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this.fen())>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:L=!1,square:j=void 0,piece:N=void 0}={}){let u=this._moves({square:j,piece:N});return L?u.map(I=>new iM(this,I)):u.map(I=>this._moveToSan(I,u))}_moves({legal:L=!0,piece:j=void 0,square:N=void 0}={}){let u=N?N.toLowerCase():void 0,I=j?.toLowerCase(),t=[],g=this._turn,y=AM(g),i=c.a8,A=c.h1,T=!1;if(u)if(u in c)i=A=c[u],T=!0;else return[];for(let S=i;S<=A;S++){if(S&136){S+=7;continue}if(!this._board[S]||this._board[S].color===y)continue;let{type:e}=this._board[S],z;if(e===Q){if(I&&I!==e)continue;z=S+RM[g][0],this._board[z]||(q(t,g,S,z,Q),z=S+RM[g][1],fj[g]===IM(S)&&!this._board[z]&&q(t,g,S,z,Q,void 0,x.BIG_PAWN));for(let r=2;r<4;r++)z=S+RM[g][r],!(z&136)&&(this._board[z]?.color===y?q(t,g,S,z,Q,this._board[z].type,x.CAPTURE):z===this._epSquare&&q(t,g,S,z,Q,Q,x.EP_CAPTURE))}else{if(I&&I!==e)continue;for(let r=0,o=cL[e].length;r<o;r++){let n=cL[e][r];for(z=S;z+=n,!(z&136);){if(!this._board[z])q(t,g,S,z,e);else{if(this._board[z].color===g)break;q(t,g,S,z,e,this._board[z].type,x.CAPTURE);break}if(e===BM||e===w)break}}}}if((I===void 0||I===w)&&(!T||A===this._kings[g])){if(this._castling[g]&x.KSIDE_CASTLE){let S=this._kings[g],e=S+2;!this._board[S+1]&&!this._board[e]&&!this._attacked(y,this._kings[g])&&!this._attacked(y,S+1)&&!this._attacked(y,e)&&q(t,g,this._kings[g],e,w,void 0,x.KSIDE_CASTLE)}if(this._castling[g]&x.QSIDE_CASTLE){let S=this._kings[g],e=S-2;!this._board[S-1]&&!this._board[S-2]&&!this._board[S-3]&&!this._attacked(y,this._kings[g])&&!this._attacked(y,S-1)&&!this._attacked(y,e)&&q(t,g,this._kings[g],e,w,void 0,x.QSIDE_CASTLE)}}if(!L||this._kings[g]===-1)return t;let D=[];for(let S=0,e=t.length;S<e;S++)this._makeMove(t[S]),this._isKingAttacked(g)||D.push(t[S]),this._undoMove();return D}move(L,{strict:j=!1}={}){let N=null;if(typeof L=="string")N=this._moveFromSan(L,j);else if(typeof L=="object"){let I=this._moves();for(let t=0,g=I.length;t<g;t++)if(L.from===d(I[t].from)&&L.to===d(I[t].to)&&(!("promotion"in I[t])||L.promotion===I[t].promotion)){N=I[t];break}}if(!N)throw typeof L=="string"?new Error(`Invalid move: ${L}`):new Error(`Invalid move: ${JSON.stringify(L)}`);let u=new iM(this,N);return this._makeMove(N),this._incPositionCount(u.after),u}_push(L){this._history.push({move:L,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(L){let j=this._turn,N=AM(j);if(this._push(L),this._board[L.to]=this._board[L.from],delete this._board[L.from],L.flags&x.EP_CAPTURE&&(this._turn===f?delete this._board[L.to-16]:delete this._board[L.to+16]),L.promotion&&(this._board[L.to]={type:L.promotion,color:j}),this._board[L.to].type===w){if(this._kings[j]=L.to,L.flags&x.KSIDE_CASTLE){let u=L.to-1,I=L.to+1;this._board[u]=this._board[I],delete this._board[I]}else if(L.flags&x.QSIDE_CASTLE){let u=L.to+1,I=L.to-2;this._board[u]=this._board[I],delete this._board[I]}this._castling[j]=0}if(this._castling[j]){for(let u=0,I=F[j].length;u<I;u++)if(L.from===F[j][u].square&&this._castling[j]&F[j][u].flag){this._castling[j]^=F[j][u].flag;break}}if(this._castling[N]){for(let u=0,I=F[N].length;u<I;u++)if(L.to===F[N][u].square&&this._castling[N]&F[N][u].flag){this._castling[N]^=F[N][u].flag;break}}L.flags&x.BIG_PAWN?j===f?this._epSquare=L.to-16:this._epSquare=L.to+16:this._epSquare=b,L.piece===Q?this._halfMoves=0:L.flags&(x.CAPTURE|x.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,j===f&&this._moveNumber++,this._turn=N}undo(){let L=this._undoMove();if(L){let j=new iM(this,L);return this._decPositionCount(j.after),j}return null}_undoMove(){let L=this._history.pop();if(L===void 0)return null;let j=L.move;this._kings=L.kings,this._turn=L.turn,this._castling=L.castling,this._epSquare=L.epSquare,this._halfMoves=L.halfMoves,this._moveNumber=L.moveNumber;let N=this._turn,u=AM(N);if(this._board[j.from]=this._board[j.to],this._board[j.from].type=j.piece,delete this._board[j.to],j.captured)if(j.flags&x.EP_CAPTURE){let I;N===f?I=j.to-16:I=j.to+16,this._board[I]={type:Q,color:u}}else this._board[j.to]={type:j.captured,color:u};if(j.flags&(x.KSIDE_CASTLE|x.QSIDE_CASTLE)){let I,t;j.flags&x.KSIDE_CASTLE?(I=j.to+1,t=j.to-1):(I=j.to-2,t=j.to+1),this._board[I]=this._board[t],delete this._board[t]}return j}pgn({newline:L=`
`,maxWidth:j=0}={}){let N=[],u=!1;for(let D in this._header)N.push("["+D+' "'+this._header[D]+'"]'+L),u=!0;u&&this._history.length&&N.push(L);let I=D=>{let S=this._comments[this.fen()];if(typeof S<"u"){let e=D.length>0?" ":"";D=`${D}${e}{${S}}`}return D},t=[];for(;this._history.length>0;)t.push(this._undoMove());let g=[],y="";for(t.length===0&&g.push(I(""));t.length>0;){y=I(y);let D=t.pop();if(!D)break;if(!this._history.length&&D.color==="b"){let S=`${this._moveNumber}. ...`;y=y?`${y} ${S}`:S}else D.color==="w"&&(y.length&&g.push(y),y=this._moveNumber+".");y=y+" "+this._moveToSan(D,this._moves({legal:!0})),this._makeMove(D)}if(y.length&&g.push(I(y)),typeof this._header.Result<"u"&&g.push(this._header.Result),j===0)return N.join("")+g.join(" ");let i=function(){return N.length>0&&N[N.length-1]===" "?(N.pop(),!0):!1},A=function(D,S){for(let e of S.split(" "))if(e){if(D+e.length>j){for(;i();)D--;N.push(L),D=0}N.push(e),D+=e.length,N.push(" "),D++}return i()&&D--,D},T=0;for(let D=0;D<g.length;D++){if(T+g[D].length>j&&g[D].includes("{")){T=A(T,g[D]);continue}T+g[D].length>j&&D!==0?(N[N.length-1]===" "&&N.pop(),N.push(L),T=0):D!==0&&(N.push(" "),T++),N.push(g[D]),T+=g[D].length}return N.join("")}header(...L){for(let j=0;j<L.length;j+=2)typeof L[j]=="string"&&typeof L[j+1]=="string"&&(this._header[L[j]]=L[j+1]);return this._header}setHeader(L,j){return this._header[L]=j,this._header}removeHeader(L){return L in this._header?(delete this._header[L],!0):!1}getHeaders(){return this._header}loadPgn(L,{strict:j=!1,newlineChar:N=`\r?
`}={}){function u(E){return E.replace(/\\/g,"\\")}function I(E){let U={},s=E.split(new RegExp(u(N))),jM="",NM="";for(let O=0;O<s.length;O++){let X=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;jM=s[O].replace(X,"$1"),NM=s[O].replace(X,"$2"),jM.trim().length>0&&(U[jM]=NM)}return U}L=L.trim();let g=new RegExp("^(\\[((?:"+u(N)+")|.)*\\])((?:\\s*"+u(N)+"){2}|(?:\\s*"+u(N)+")*$)").exec(L),y=g&&g.length>=2?g[1]:"";this.reset();let i=I(y),A="";for(let E in i)E.toLowerCase()==="fen"&&(A=i[E]),this.header(E,i[E]);if(!j)A&&this.load(A,{preserveHeaders:!0});else if(i.SetUp==="1"){if(!("FEN"in i))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(i.FEN,{preserveHeaders:!0})}function T(E){return Array.from(E).map(function(U){return U.charCodeAt(0)<128?U.charCodeAt(0).toString(16):encodeURIComponent(U).replace(/%/g,"").toLowerCase()}).join("")}function D(E){return E.length==0?"":decodeURIComponent("%"+(E.match(/.{1,2}/g)||[]).join("%"))}let S=function(E){return E=E.replace(new RegExp(u(N),"g")," "),`{${T(E.slice(1,E.length-1))}}`},e=function(E){if(E.startsWith("{")&&E.endsWith("}"))return D(E.slice(1,E.length-1))},z=L.replace(y,"").replace(new RegExp(`({[^}]*})+?|;([^${u(N)}]*)`,"g"),function(E,U,s){return U!==void 0?S(U):" "+S(`{${s.slice(1)}}`)}).replace(new RegExp(u(N),"g")," "),r=/(\([^()]+\))+?/g;for(;r.test(z);)z=z.replace(r,"");z=z.replace(/\d+\.(\.\.)?/g,""),z=z.replace(/\.\.\./g,""),z=z.replace(/\$\d+/g,"");let o=z.trim().split(new RegExp(/\s+/));o=o.filter(E=>E!=="");let n="";for(let E=0;E<o.length;E++){let U=e(o[E]);if(U!==void 0){this._comments[this.fen()]=U;continue}let s=this._moveFromSan(o[E],j);if(s==null)if(Zj.indexOf(o[E])>-1)n=o[E];else throw new Error(`Invalid move in PGN: ${o[E]}`);else n="",this._makeMove(s),this._incPositionCount(this.fen())}n&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",n)}_moveToSan(L,j){let N="";if(L.flags&x.KSIDE_CASTLE)N="O-O";else if(L.flags&x.QSIDE_CASTLE)N="O-O-O";else{if(L.piece!==Q){let u=Pj(L,j);N+=L.piece.toUpperCase()+u}L.flags&(x.CAPTURE|x.EP_CAPTURE)&&(L.piece===Q&&(N+=d(L.from)[0]),N+="x"),N+=d(L.to),L.promotion&&(N+="="+L.promotion.toUpperCase())}return this._makeMove(L),this.isCheck()&&(this.isCheckmate()?N+="#":N+="+"),this._undoMove(),N}_moveFromSan(L,j=!1){let N=VM(L),u=CL(N),I=this._moves({legal:!0,piece:u});for(let D=0,S=I.length;D<S;D++)if(N===VM(this._moveToSan(I[D],I)))return I[D];if(j)return null;let t,g,y,i,A,T=!1;if(g=N.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),g?(t=g[1],y=g[2],i=g[3],A=g[4],y.length==1&&(T=!0)):(g=N.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),g&&(t=g[1],y=g[2],i=g[3],A=g[4],y.length==1&&(T=!0))),u=CL(N),I=this._moves({legal:!0,piece:t||u}),!i)return null;for(let D=0,S=I.length;D<S;D++)if(y){if((!t||t.toLowerCase()==I[D].piece)&&c[y]==I[D].from&&c[i]==I[D].to&&(!A||A.toLowerCase()==I[D].promotion))return I[D];if(T){let e=d(I[D].from);if((!t||t.toLowerCase()==I[D].piece)&&c[i]==I[D].to&&(y==e[0]||y==e[1])&&(!A||A.toLowerCase()==I[D].promotion))return I[D]}}else if(N===VM(this._moveToSan(I[D],I)).replace("x",""))return I[D];return null}ascii(){let L=`   +------------------------+
`;for(let j=c.a8;j<=c.h1;j++){if(eM(j)===0&&(L+=" "+"87654321"[IM(j)]+" |"),this._board[j]){let N=this._board[j].type,I=this._board[j].color===l?N.toUpperCase():N.toLowerCase();L+=" "+I+" "}else L+=" . ";j+1&136&&(L+=`|
`,j+=8)}return L+=`   +------------------------+
`,L+="     a  b  c  d  e  f  g  h",L}perft(L){let j=this._moves({legal:!1}),N=0,u=this._turn;for(let I=0,t=j.length;I<t;I++)this._makeMove(j[I]),this._isKingAttacked(u)||(L-1>0?N+=this.perft(L-1):N++),this._undoMove();return N}turn(){return this._turn}board(){let L=[],j=[];for(let N=c.a8;N<=c.h1;N++)this._board[N]==null?j.push(null):j.push({square:d(N),type:this._board[N].type,color:this._board[N].color}),N+1&136&&(L.push(j),j=[],N+=8);return L}squareColor(L){if(L in c){let j=c[L];return(IM(j)+eM(j))%2===0?"light":"dark"}return null}history({verbose:L=!1}={}){let j=[],N=[];for(;this._history.length>0;)j.push(this._undoMove());for(;;){let u=j.pop();if(!u)break;L?N.push(new iM(this,u)):N.push(this._moveToSan(u,this._moves())),this._makeMove(u)}return N}_getPositionCount(L){let j=_M(L);return this._positionCount[j]||0}_incPositionCount(L){let j=_M(L);this._positionCount[j]===void 0&&(this._positionCount[j]=0),this._positionCount[j]+=1}_decPositionCount(L){let j=_M(L);this._positionCount[j]===1?delete this._positionCount[j]:this._positionCount[j]-=1}_pruneComments(){let L=[],j={},N=u=>{u in this._comments&&(j[u]=this._comments[u])};for(;this._history.length>0;)L.push(this._undoMove());for(N(this.fen());;){let u=L.pop();if(!u)break;this._makeMove(u),N(this.fen())}this._comments=j}getComment(){return this._comments[this.fen()]}setComment(L){this._comments[this.fen()]=L.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let L=this._comments[this.fen()];return delete this._comments[this.fen()],L}getComments(){return this._pruneComments(),Object.keys(this._comments).map(L=>({fen:L,comment:this._comments[L]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(L=>{let j=this._comments[L];return delete this._comments[L],{fen:L,comment:j}})}setCastlingRights(L,j){for(let u of[w,K])j[u]!==void 0&&(j[u]?this._castling[L]|=aM[u]:this._castling[L]&=~aM[u]);this._updateCastlingRights();let N=this.getCastlingRights(L);return(j[w]===void 0||j[w]===N[w])&&(j[K]===void 0||j[K]===N[K])}getCastlingRights(L){return{[w]:(this._castling[L]&aM[w])!==0,[K]:(this._castling[L]&aM[K])!==0}}moveNumber(){return this._moveNumber}};function wM(M){let L=new DM;for(let j of M)L.move(j);return L.fen()}var rL="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",nL="8/8/8/8/8/8/8/8 w - - 0 1";var YL=["white","black"],tM=["a","b","c","d","e","f","g","h"],TM=["1","2","3","4","5","6","7","8"];var sL=[...TM].reverse(),QM=Array.prototype.concat(...tM.map(M=>TM.map(L=>M+L))),m=M=>QM[8*M[0]+M[1]],C=M=>[M.charCodeAt(0)-97,M.charCodeAt(1)-49];var UM=QM.map(C);function wL(M){let L,j=()=>(L===void 0&&(L=M()),L);return j.clear=()=>{L=void 0},j}var QL=()=>{let M;return{start(){M=performance.now()},cancel(){M=void 0},stop(){if(!M)return 0;let L=performance.now()-M;return M=void 0,L}}},lM=M=>M==="white"?"black":"white",MM=(M,L)=>{let j=M[0]-L[0],N=M[1]-L[1];return j*j+N*N},xM=(M,L)=>M.role===L.role&&M.color===L.color,LM=M=>(L,j)=>[(j?L[0]:7-L[0])*M.width/8,(j?7-L[1]:L[1])*M.height/8],Z=(M,L)=>{M.style.transform=`translate(${L[0]}px,${L[1]}px)`},JM=(M,L,j=1)=>{M.style.transform=`translate(${L[0]}px,${L[1]}px) scale(${j})`},cM=(M,L)=>{M.style.visibility=L?"visible":"hidden"},V=M=>{var L;if(M.clientX||M.clientX===0)return[M.clientX,M.clientY];if(!((L=M.targetTouches)===null||L===void 0)&&L[0])return[M.targetTouches[0].clientX,M.targetTouches[0].clientY]},dM=M=>M.button===2,v=(M,L)=>{let j=document.createElement(M);return L&&(j.className=L),j};function kM(M,L,j){let N=C(M);return L||(N[0]=7-N[0],N[1]=7-N[1]),[j.left+j.width*N[0]/8+j.width/16,j.top+j.height*(7-N[1])/8+j.height/16]}var gM=(M,L)=>Math.abs(M-L),Gj=M=>(L,j,N,u)=>gM(L,N)<2&&(M==="white"?u===j+1||j<=1&&u===j+2&&L===N:u===j-1||j>=6&&u===j-2&&L===N),XM=(M,L,j,N)=>{let u=gM(M,j),I=gM(L,N);return u===1&&I===2||u===2&&I===1},UL=(M,L,j,N)=>gM(M,j)===gM(L,N),lL=(M,L,j,N)=>M===j||L===N,FM=(M,L,j,N)=>UL(M,L,j,N)||lL(M,L,j,N),Wj=(M,L,j)=>(N,u,I,t)=>gM(N,I)<2&&gM(u,t)<2||j&&u===t&&u===(M==="white"?0:7)&&(N===4&&(I===2&&L.includes(0)||I===6&&L.includes(7))||L.includes(I));function Hj(M,L){let j=L==="white"?"1":"8",N=[];for(let[u,I]of M)u[1]===j&&I.color===L&&I.role==="rook"&&N.push(C(u)[0]);return N}function qM(M,L,j){let N=M.get(L);if(!N)return[];let u=C(L),I=N.role,t=I==="pawn"?Gj(N.color):I==="knight"?XM:I==="bishop"?UL:I==="rook"?lL:I==="queen"?FM:Wj(N.color,Hj(M,N.color),j);return UM.filter(g=>(u[0]!==g[0]||u[1]!==g[1])&&t(u[0],u[1],g[0],g[1])).map(m)}function p(M,...L){M&&setTimeout(()=>M(...L),1)}function dL(M){M.orientation=lM(M.orientation),M.animation.current=M.draggable.current=M.selected=void 0}function kL(M,L){for(let[j,N]of L)N?M.pieces.set(j,N):M.pieces.delete(j)}function mL(M,L){if(M.check=void 0,L===!0&&(L=M.turnColor),L)for(let[j,N]of M.pieces)N.role==="king"&&N.color===L&&(M.check=j)}function Rj(M,L,j,N){G(M),M.premovable.current=[L,j],p(M.premovable.events.set,L,j,N)}function P(M){M.premovable.current&&(M.premovable.current=void 0,p(M.premovable.events.unset))}function Vj(M,L,j){P(M),M.predroppable.current={role:L,key:j},p(M.predroppable.events.set,L,j)}function G(M){let L=M.predroppable;L.current&&(L.current=void 0,p(L.events.unset))}function _j(M,L,j){if(!M.autoCastle)return!1;let N=M.pieces.get(L);if(!N||N.role!=="king")return!1;let u=C(L),I=C(j);if(u[1]!==0&&u[1]!==7||u[1]!==I[1])return!1;u[0]===4&&!M.pieces.has(j)&&(I[0]===6?j=m([7,I[1]]):I[0]===2&&(j=m([0,I[1]])));let t=M.pieces.get(j);return!t||t.color!==N.color||t.role!=="rook"?!1:(M.pieces.delete(L),M.pieces.delete(j),u[0]<I[0]?(M.pieces.set(m([6,I[1]]),N),M.pieces.set(m([5,I[1]]),t)):(M.pieces.set(m([2,I[1]]),N),M.pieces.set(m([3,I[1]]),t)),!0)}function KM(M,L,j){let N=M.pieces.get(L),u=M.pieces.get(j);if(L===j||!N)return!1;let I=u&&u.color!==N.color?u:void 0;return j===M.selected&&h(M),p(M.events.move,L,j,I),_j(M,L,j)||(M.pieces.set(j,N),M.pieces.delete(L)),M.lastMove=[L,j],M.check=void 0,p(M.events.change),I||!0}function mM(M,L,j,N){if(M.pieces.has(j))if(N)M.pieces.delete(j);else return!1;return p(M.events.dropNewPiece,L,j),M.pieces.set(j,L),M.lastMove=[j],M.check=void 0,p(M.events.change),M.movable.dests=void 0,M.turnColor=lM(M.turnColor),!0}function hL(M,L,j){let N=KM(M,L,j);return N&&(M.movable.dests=void 0,M.turnColor=lM(M.turnColor),M.animation.current=void 0),N}function $M(M,L,j){if(pM(M,L,j)){let N=hL(M,L,j);if(N){let u=M.hold.stop();h(M);let I={premove:!1,ctrlKey:M.stats.ctrlKey,holdTime:u};return N!==!0&&(I.captured=N),p(M.movable.events.after,L,j,I),!0}}else if(Jj(M,L,j))return Rj(M,L,j,{ctrlKey:M.stats.ctrlKey}),h(M),!0;return h(M),!1}function hM(M,L,j,N){let u=M.pieces.get(L);u&&(Bj(M,L,j)||N)?(M.pieces.delete(L),mM(M,u,j,N),p(M.movable.events.afterNewPiece,u.role,j,{premove:!1,predrop:!1})):u&&Xj(M,L,j)?Vj(M,u.role,j):(P(M),G(M)),M.pieces.delete(L),h(M)}function CM(M,L,j){if(p(M.events.select,L),M.selected){if(M.selected===L&&!M.draggable.enabled){h(M),M.hold.cancel();return}else if((M.selectable.enabled||j)&&M.selected!==L&&$M(M,M.selected,L)){M.stats.dragged=!1;return}}(M.selectable.enabled||M.draggable.enabled)&&(pL(M,L)||LL(M,L))&&(ML(M,L),M.hold.start())}function ML(M,L){M.selected=L,LL(M,L)?M.premovable.customDests||(M.premovable.dests=qM(M.pieces,L,M.premovable.castle)):M.premovable.dests=void 0}function h(M){M.selected=void 0,M.premovable.dests=void 0,M.hold.cancel()}function pL(M,L){let j=M.pieces.get(L);return!!j&&(M.movable.color==="both"||M.movable.color===j.color&&M.turnColor===j.color)}var pM=(M,L,j)=>{var N,u;return L!==j&&pL(M,L)&&(M.movable.free||!!(!((u=(N=M.movable.dests)===null||N===void 0?void 0:N.get(L))===null||u===void 0)&&u.includes(j)))};function Bj(M,L,j){let N=M.pieces.get(L);return!!N&&(L===j||!M.pieces.has(j))&&(M.movable.color==="both"||M.movable.color===N.color&&M.turnColor===N.color)}function LL(M,L){let j=M.pieces.get(L);return!!j&&M.premovable.enabled&&M.movable.color===j.color&&M.turnColor!==j.color}function Jj(M,L,j){var N,u;let I=(u=(N=M.premovable.customDests)===null||N===void 0?void 0:N.get(L))!==null&&u!==void 0?u:qM(M.pieces,L,M.premovable.castle);return L!==j&&LL(M,L)&&I.includes(j)}function Xj(M,L,j){let N=M.pieces.get(L),u=M.pieces.get(j);return!!N&&(!u||u.color!==M.movable.color)&&M.predroppable.enabled&&(N.role!=="pawn"||j[1]!=="1"&&j[1]!=="8")&&M.movable.color===N.color&&M.turnColor!==N.color}function bL(M,L){let j=M.pieces.get(L);return!!j&&M.draggable.enabled&&(M.movable.color==="both"||M.movable.color===j.color&&(M.turnColor===j.color||M.premovable.enabled))}function fL(M){let L=M.premovable.current;if(!L)return!1;let j=L[0],N=L[1],u=!1;if(pM(M,j,N)){let I=hL(M,j,N);if(I){let t={premove:!0};I!==!0&&(t.captured=I),p(M.movable.events.after,j,N,t),u=!0}}return P(M),u}function ZL(M,L){let j=M.predroppable.current,N=!1;if(!j)return!1;if(L(j)){let u={role:j.role,color:M.movable.color};mM(M,u,j.key)&&(p(M.movable.events.afterNewPiece,j.role,j.key,{premove:!1,predrop:!0}),N=!0)}return G(M),N}function OM(M){P(M),G(M),h(M)}function jL(M){M.movable.color=M.movable.dests=M.animation.current=void 0,OM(M)}function W(M,L,j){let N=Math.floor(8*(M[0]-j.left)/j.width);L||(N=7-N);let u=7-Math.floor(8*(M[1]-j.top)/j.height);return L||(u=7-u),N>=0&&N<8&&u>=0&&u<8?m([N,u]):void 0}function vL(M,L,j,N){let u=C(M),I=UM.filter(i=>FM(u[0],u[1],i[0],i[1])||XM(u[0],u[1],i[0],i[1])),g=I.map(i=>kM(m(i),j,N)).map(i=>MM(L,i)),[,y]=g.reduce((i,A,T)=>i[0]<A?i:[A,T],[g[0],0]);return m(I[y])}var Y=M=>M.orientation==="white";var uL="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Fj={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},qj={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function bM(M){M==="start"&&(M=uL);let L=new Map,j=7,N=0;for(let u of M)switch(u){case" ":case"[":return L;case"/":if(--j,j<0)return L;N=0;break;case"~":{let I=L.get(m([N-1,j]));I&&(I.promoted=!0);break}default:{let I=u.charCodeAt(0);if(I<57)N+=I-48;else{let t=u.toLowerCase();L.set(m([N,j]),{role:Fj[t],color:u===t?"black":"white"}),++N}}}return L}function PL(M){return sL.map(L=>tM.map(j=>{let N=M.get(j+L);if(N){let u=qj[N.role];return N.color==="white"&&(u=u.toUpperCase()),N.promoted&&(u+="~"),u}else return"1"}).join("")).join("/").replace(/1{2,}/g,L=>L.length.toString())}function IL(M,L){L.animation&&(tL(M.animation,L.animation),(M.animation.duration||0)<70&&(M.animation.enabled=!1))}function fM(M,L){var j,N,u;if(!((j=L.movable)===null||j===void 0)&&j.dests&&(M.movable.dests=void 0),!((N=L.drawable)===null||N===void 0)&&N.autoShapes&&(M.drawable.autoShapes=[]),tL(M,L),L.fen&&(M.pieces=bM(L.fen),M.drawable.shapes=((u=L.drawable)===null||u===void 0?void 0:u.shapes)||[]),"check"in L&&mL(M,L.check||!1),"lastMove"in L&&!L.lastMove?M.lastMove=void 0:L.lastMove&&(M.lastMove=L.lastMove),M.selected&&ML(M,M.selected),IL(M,L),!M.movable.rookCastle&&M.movable.dests){let I=M.movable.color==="white"?"1":"8",t="e"+I,g=M.movable.dests.get(t),y=M.pieces.get(t);if(!g||!y||y.role!=="king")return;M.movable.dests.set(t,g.filter(i=>!(i==="a"+I&&g.includes("c"+I))&&!(i==="h"+I&&g.includes("g"+I))))}}function tL(M,L){for(let j in L)Object.prototype.hasOwnProperty.call(L,j)&&(Object.prototype.hasOwnProperty.call(M,j)&&GL(M[j])&&GL(L[j])?tL(M[j],L[j]):M[j]=L[j])}function GL(M){if(typeof M!="object"||M===null)return!1;let L=Object.getPrototypeOf(M);return L===Object.prototype||L===null}var _=(M,L)=>L.animation.enabled?L4(M,L):B(M,L);function B(M,L){let j=M(L);return L.dom.redraw(),j}var gL=(M,L)=>({key:M,pos:C(M),piece:L}),$j=(M,L)=>L.sort((j,N)=>MM(M.pos,j.pos)-MM(M.pos,N.pos))[0];function M4(M,L){let j=new Map,N=[],u=new Map,I=[],t=[],g=new Map,y,i,A;for(let[T,D]of M)g.set(T,gL(T,D));for(let T of QM)y=L.pieces.get(T),i=g.get(T),y?i?xM(y,i.piece)||(I.push(i),t.push(gL(T,y))):t.push(gL(T,y)):i&&I.push(i);for(let T of t)i=$j(T,I.filter(D=>xM(T.piece,D.piece))),i&&(A=[i.pos[0]-T.pos[0],i.pos[1]-T.pos[1]],j.set(T.key,A.concat(A)),N.push(i.key));for(let T of I)N.includes(T.key)||u.set(T.key,T.piece);return{anims:j,fadings:u}}function WL(M,L){let j=M.animation.current;if(j===void 0){M.dom.destroyed||M.dom.redrawNow();return}let N=1-(L-j.start)*j.frequency;if(N<=0)M.animation.current=void 0,M.dom.redrawNow();else{let u=j4(N);for(let I of j.plan.anims.values())I[2]=I[0]*u,I[3]=I[1]*u;M.dom.redrawNow(!0),requestAnimationFrame((I=performance.now())=>WL(M,I))}}function L4(M,L){let j=new Map(L.pieces),N=M(L),u=M4(j,L);if(u.anims.size||u.fadings.size){let I=L.animation.current&&L.animation.current.start;L.animation.current={start:performance.now(),frequency:1/L.animation.duration,plan:u},I||WL(L,performance.now())}else L.dom.redraw();return N}var j4=M=>M<.5?4*M*M*M:(M-1)*(2*M-2)*(2*M-2)+1;var N4=["green","red","blue","yellow"];function HL(M,L){if(L.touches&&L.touches.length>1)return;L.stopPropagation(),L.preventDefault(),L.ctrlKey?h(M):OM(M);let j=V(L),N=W(j,Y(M),M.dom.bounds());N&&(M.drawable.current={orig:N,pos:j,brush:u4(L),snapToValidMove:M.drawable.defaultSnapToValidMove},RL(M))}function RL(M){requestAnimationFrame(()=>{let L=M.drawable.current;if(L){let j=W(L.pos,Y(M),M.dom.bounds());j||(L.snapToValidMove=!1);let N=L.snapToValidMove?vL(L.orig,L.pos,Y(M),M.dom.bounds()):j;N!==L.mouseSq&&(L.mouseSq=N,L.dest=N!==L.orig?N:void 0,M.dom.redrawNow()),RL(M)}})}function VL(M,L){M.drawable.current&&(M.drawable.current.pos=V(L))}function _L(M){let L=M.drawable.current;L&&(L.mouseSq&&I4(M.drawable,L),yL(M))}function yL(M){M.drawable.current&&(M.drawable.current=void 0,M.dom.redraw())}function BL(M){M.drawable.shapes.length&&(M.drawable.shapes=[],M.dom.redraw(),JL(M.drawable))}function u4(M){var L;let j=(M.shiftKey||M.ctrlKey)&&dM(M),N=M.altKey||M.metaKey||((L=M.getModifierState)===null||L===void 0?void 0:L.call(M,"AltGraph"));return N4[(j?1:0)+(N?2:0)]}function I4(M,L){let j=u=>u.orig===L.orig&&u.dest===L.dest,N=M.shapes.find(j);N&&(M.shapes=M.shapes.filter(u=>!j(u))),(!N||N.brush!==L.brush)&&M.shapes.push({orig:L.orig,dest:L.dest,brush:L.brush}),JL(M)}function JL(M){M.onChange&&M.onChange(M.shapes)}function XL(M,L){if(!(M.trustAllEvents||L.isTrusted)||L.buttons!==void 0&&L.buttons>1||L.touches&&L.touches.length>1)return;let j=M.dom.bounds(),N=V(L),u=W(N,Y(M),j);if(!u)return;let I=M.pieces.get(u),t=M.selected;if(!t&&M.drawable.enabled&&(M.drawable.eraseOnClick||!I||I.color!==M.turnColor)&&BL(M),L.cancelable!==!1&&(!L.touches||M.blockTouchScroll||I||t||g4(M,N)))L.preventDefault();else if(L.touches)return;let g=!!M.premovable.current,y=!!M.predroppable.current;M.stats.ctrlKey=L.ctrlKey,M.selected&&pM(M,M.selected,u)?_(T=>CM(T,u),M):CM(M,u);let i=M.selected===u,A=Mj(M,u);if(I&&A&&i&&bL(M,u)){M.draggable.current={orig:u,piece:I,origPos:N,pos:N,started:M.draggable.autoDistance&&M.stats.dragged,element:A,previouslySelected:t,originTarget:L.target,keyHasChanged:!1},A.cgDragging=!0,A.classList.add("dragging");let T=M.dom.elements.ghost;T&&(T.className=`ghost ${I.color} ${I.role}`,Z(T,LM(j)(C(u),Y(M))),cM(T,!0)),iL(M)}else g&&P(M),y&&G(M);M.dom.redraw()}function g4(M,L){let j=Y(M),N=M.dom.bounds(),u=Math.pow(N.width/8,2);for(let I of M.pieces.keys()){let t=kM(I,j,N);if(MM(t,L)<=u)return!0}return!1}function FL(M,L,j,N){let u="a0";M.pieces.set(u,L),M.dom.redraw();let I=V(j);M.draggable.current={orig:u,piece:L,origPos:I,pos:I,started:!0,element:()=>Mj(M,u),originTarget:j.target,newPiece:!0,force:!!N,keyHasChanged:!1},iL(M)}function iL(M){requestAnimationFrame(()=>{var L;let j=M.draggable.current;if(!j)return;!((L=M.animation.current)===null||L===void 0)&&L.plan.anims.has(j.orig)&&(M.animation.current=void 0);let N=M.pieces.get(j.orig);if(!N||!xM(N,j.piece))yM(M);else if(!j.started&&MM(j.pos,j.origPos)>=Math.pow(M.draggable.distance,2)&&(j.started=!0),j.started){if(typeof j.element=="function"){let I=j.element();if(!I)return;I.cgDragging=!0,I.classList.add("dragging"),j.element=I}let u=M.dom.bounds();Z(j.element,[j.pos[0]-u.left-u.width/16,j.pos[1]-u.top-u.height/16]),j.keyHasChanged||(j.keyHasChanged=j.orig!==W(j.pos,Y(M),u))}iL(M)})}function qL(M,L){M.draggable.current&&(!L.touches||L.touches.length<2)&&(M.draggable.current.pos=V(L))}function KL(M,L){let j=M.draggable.current;if(!j)return;if(L.type==="touchend"&&L.cancelable!==!1&&L.preventDefault(),L.type==="touchend"&&j.originTarget!==L.target&&!j.newPiece){M.draggable.current=void 0;return}P(M),G(M);let N=V(L)||j.pos,u=W(N,Y(M),M.dom.bounds());u&&j.started&&j.orig!==u?j.newPiece?hM(M,j.orig,u,j.force):(M.stats.ctrlKey=L.ctrlKey,$M(M,j.orig,u)&&(M.stats.dragged=!0)):j.newPiece?M.pieces.delete(j.orig):M.draggable.deleteOnDropOff&&!u&&(M.pieces.delete(j.orig),p(M.events.change)),(j.orig===j.previouslySelected||j.keyHasChanged)&&(j.orig===u||!u)?h(M):M.selectable.enabled||h(M),$L(M),M.draggable.current=void 0,M.dom.redraw()}function yM(M){let L=M.draggable.current;L&&(L.newPiece&&M.pieces.delete(L.orig),M.draggable.current=void 0,h(M),$L(M),M.dom.redraw())}function $L(M){let L=M.dom.elements;L.ghost&&cM(L.ghost,!1)}function Mj(M,L){let j=M.dom.elements.board.firstChild;for(;j;){if(j.cgKey===L&&j.tagName==="PIECE")return j;j=j.nextSibling}}function jj(M,L){M.exploding={stage:1,keys:L},M.dom.redraw(),setTimeout(()=>{Lj(M,2),setTimeout(()=>Lj(M,void 0),120)},120)}function Lj(M,L){M.exploding&&(L?M.exploding.stage=L:M.exploding=void 0,M.dom.redraw())}function Nj(M,L){function j(){dL(M),L()}return{set(N){N.orientation&&N.orientation!==M.orientation&&j(),IL(M,N),(N.fen?_:B)(u=>fM(u,N),M)},state:M,getFen:()=>PL(M.pieces),toggleOrientation:j,setPieces(N){_(u=>kL(u,N),M)},selectSquare(N,u){N?_(I=>CM(I,N,u),M):M.selected&&(h(M),M.dom.redraw())},move(N,u){_(I=>KM(I,N,u),M)},newPiece(N,u){_(I=>mM(I,N,u),M)},playPremove(){if(M.premovable.current){if(_(fL,M))return!0;M.dom.redraw()}return!1},playPredrop(N){if(M.predroppable.current){let u=ZL(M,N);return M.dom.redraw(),u}return!1},cancelPremove(){B(P,M)},cancelPredrop(){B(G,M)},cancelMove(){B(N=>{OM(N),yM(N)},M)},stop(){B(N=>{jL(N),yM(N)},M)},explode(N){jj(M,N)},setAutoShapes(N){B(u=>u.drawable.autoShapes=N,M)},setShapes(N){B(u=>u.drawable.shapes=N,M)},getKeyAtDomPos(N){return W(N,Y(M),M.dom.bounds())},redrawAll:L,dragNewPiece(N,u,I){FL(M,N,u,I)},destroy(){jL(M),M.dom.unbind&&M.dom.unbind(),M.dom.destroyed=!0}}}function uj(){return{pieces:bM(uL),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:QL()}}var Ij={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function yj(){let M=a("defs"),L=k(a("filter"),{id:"cg-filter-blur"});return L.appendChild(k(a("feGaussianBlur"),{stdDeviation:"0.019"})),M.appendChild(L),M}function ij(M,L,j){var N;let u=M.drawable,I=u.current,t=I&&I.mouseSq?I:void 0,g=new Map,y=M.dom.bounds(),i=u.autoShapes.filter(S=>!S.piece);for(let S of u.shapes.concat(i).concat(t?[t]:[])){if(!S.dest)continue;let e=(N=g.get(S.dest))!==null&&N!==void 0?N:new Set,z=PM(vM(C(S.orig),M.orientation),y),r=PM(vM(C(S.dest),M.orientation),y);e.add(TL(z,r)),g.set(S.dest,e)}let A=u.shapes.concat(i).map(S=>({shape:S,current:!1,hash:tj(S,DL(S.dest,g),!1,y)}));t&&A.push({shape:t,current:!0,hash:tj(t,DL(t.dest,g),!0,y)});let T=A.map(S=>S.hash).join(";");if(T===M.drawable.prevSvgHash)return;M.drawable.prevSvgHash=T;let D=L.querySelector("defs");i4(u,A,D),D4(A,L.querySelector("g"),j.querySelector("g"),S=>A4(M,S,u.brushes,g,y))}function i4(M,L,j){var N;let u=new Map,I;for(let y of L.filter(i=>i.shape.dest&&i.shape.brush))I=Dj(M.brushes[y.shape.brush],y.shape.modifiers),!((N=y.shape.modifiers)===null||N===void 0)&&N.hilite&&u.set(ZM(I).key,ZM(I)),u.set(I.key,I);let t=new Set,g=j.firstElementChild;for(;g;)t.add(g.getAttribute("cgKey")),g=g.nextElementSibling;for(let[y,i]of u.entries())t.has(y)||j.appendChild(x4(i))}function D4(M,L,j,N){let u=new Map;for(let I of M)u.set(I.hash,!1);for(let I of[L,j]){let t=[],g=I.firstElementChild,y;for(;g;)y=g.getAttribute("cgHash"),u.has(y)?u.set(y,!0):t.push(g),g=g.nextElementSibling;for(let i of t)I.removeChild(i)}for(let I of M.filter(t=>!u.get(t.hash)))for(let t of N(I))t.isCustom?j.appendChild(t.el):L.appendChild(t.el)}function tj({orig:M,dest:L,brush:j,piece:N,modifiers:u,customSvg:I,label:t},g,y,i){var A,T;return[i.width,i.height,y,M,L,j,g&&"-",N&&T4(N),u&&S4(u),I&&`custom-${gj(I.html)},${(T=(A=I.center)===null||A===void 0?void 0:A[0])!==null&&T!==void 0?T:"o"}`,t&&`label-${gj(t.text)}`].filter(D=>D).join(",")}function T4(M){return[M.color,M.role,M.scale].filter(L=>L).join(",")}function S4(M){return[M.lineWidth,M.hilite&&"*"].filter(L=>L).join(",")}function gj(M){let L=0;for(let j=0;j<M.length;j++)L=(L<<5)-L+M.charCodeAt(j)>>>0;return L.toString()}function A4(M,{shape:L,current:j,hash:N},u,I,t){var g,y;let i=PM(vM(C(L.orig),M.orientation),t),A=L.dest?PM(vM(C(L.dest),M.orientation),t):i,T=L.brush&&Dj(u[L.brush],L.modifiers),D=I.get(L.dest),S=[];if(T){let e=k(a("g"),{cgHash:N});S.push({el:e}),i[0]!==A[0]||i[1]!==A[1]?e.appendChild(e4(L,T,i,A,j,DL(L.dest,I))):e.appendChild(z4(u[L.brush],i,j,t))}if(L.label){let e=L.label;(g=e.fill)!==null&&g!==void 0||(e.fill=L.brush&&u[L.brush].color);let z=L.brush?void 0:"tr";S.push({el:c4(e,N,i,A,D,z),isCustom:!0})}if(L.customSvg){let e=(y=L.customSvg.center)!==null&&y!==void 0?y:"orig",[z,r]=e==="label"?Sj(i,A,D).map(n=>n-.5):e==="dest"?A:i,o=k(a("g"),{transform:`translate(${z},${r})`,cgHash:N});o.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${L.customSvg.html}</svg>`,S.push({el:o,isCustom:!0})}return S}function z4(M,L,j,N){let u=E4(),I=(N.width+N.height)/(4*Math.max(N.width,N.height));return k(a("circle"),{stroke:M.color,"stroke-width":u[j?0:1],fill:"none",opacity:Tj(M,j),cx:L[0],cy:L[1],r:I-u[1]/2})}function ZM(M){return["#ffffff","#fff","white"].includes(M.color)?Ij.hilitePrimary:Ij.hiliteWhite}function e4(M,L,j,N,u,I){var t;function g(A){var T;let D=O4(I&&!u),S=N[0]-j[0],e=N[1]-j[1],z=Math.atan2(e,S),r=Math.cos(z)*D,o=Math.sin(z)*D;return k(a("line"),{stroke:A?ZM(L).color:L.color,"stroke-width":C4(L,u)+(A?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${A?ZM(L).key:L.key})`,opacity:!((T=M.modifiers)===null||T===void 0)&&T.hilite?1:Tj(L,u),x1:j[0],y1:j[1],x2:N[0]-r,y2:N[1]-o})}if(!(!((t=M.modifiers)===null||t===void 0)&&t.hilite))return g(!1);let y=a("g"),i=k(a("g"),{filter:"url(#cg-filter-blur)"});return i.appendChild(o4(j,N)),i.appendChild(g(!0)),y.appendChild(i),y.appendChild(g(!1)),y}function x4(M){let L=k(a("marker"),{id:"arrowhead-"+M.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:M.key.startsWith("hilite")?1.86:2.05,refY:2});return L.appendChild(k(a("path"),{d:"M0,0 V4 L3,2 Z",fill:M.color})),L.setAttribute("cgKey",M.key),L}function c4(M,L,j,N,u,I){var t;let y=.4*.75**M.text.length,i=Sj(j,N,u),A=I==="tr"?.4:0,T=k(a("g"),{transform:`translate(${i[0]+A},${i[1]-A})`,cgHash:L});T.appendChild(k(a("circle"),{r:.4/2,"fill-opacity":I?1:.8,"stroke-opacity":I?1:.7,"stroke-width":.03,fill:(t=M.fill)!==null&&t!==void 0?t:"#666",stroke:"white"}));let D=k(a("text"),{"font-size":y,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**M.text.length});return D.innerHTML=M.text,T.appendChild(D),T}function vM(M,L){return L==="white"?M:[7-M[0],7-M[1]]}function DL(M,L){return(M&&L.has(M)&&L.get(M).size>1)===!0}function a(M){return document.createElementNS("http://www.w3.org/2000/svg",M)}function k(M,L){for(let j in L)Object.prototype.hasOwnProperty.call(L,j)&&M.setAttribute(j,L[j]);return M}function Dj(M,L){return L?{color:M.color,opacity:Math.round(M.opacity*10)/10,lineWidth:Math.round(L.lineWidth||M.lineWidth),key:[M.key,L.lineWidth].filter(j=>j).join("")}:M}function E4(){return[3/64,4/64]}function C4(M,L){return(M.lineWidth||10)*(L?.85:1)/64}function Tj(M,L){return(M.opacity||1)*(L?.9:1)}function O4(M){return(M?20:10)/64}function PM(M,L){let j=Math.min(1,L.width/L.height),N=Math.min(1,L.height/L.width);return[(M[0]-3.5)*j,(3.5-M[1])*N]}function o4(M,L){let j={from:[Math.floor(Math.min(M[0],L[0])),Math.floor(Math.min(M[1],L[1]))],to:[Math.ceil(Math.max(M[0],L[0])),Math.ceil(Math.max(M[1],L[1]))]};return k(a("rect"),{x:j.from[0],y:j.from[1],width:j.to[0]-j.from[0],height:j.to[1]-j.from[1],fill:"none",stroke:"none"})}function TL(M,L,j=!0){let N=Math.atan2(L[1]-M[1],L[0]-M[0])+Math.PI;return j?(Math.round(N*8/Math.PI)+16)%16:N}function r4(M,L){return Math.sqrt([M[0]-L[0],M[1]-L[1]].reduce((j,N)=>j+N*N,0))}function Sj(M,L,j){let N=r4(M,L),u=TL(M,L,!1);if(j&&(N-=33/64,j.size>1)){N-=10/64;let I=TL(M,L);(j.has((I+1)%16)||j.has((I+15)%16))&&I&1&&(N-=.4)}return[M[0]-Math.cos(u)*N,M[1]-Math.sin(u)*N].map(I=>I+.5)}function Aj(M,L){M.innerHTML="",M.classList.add("cg-wrap");for(let y of YL)M.classList.toggle("orientation-"+y,L.orientation===y);M.classList.toggle("manipulable",!L.viewOnly);let j=v("cg-container");M.appendChild(j);let N=v("cg-board");j.appendChild(N);let u,I,t;if(L.drawable.visible&&(u=k(a("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),u.appendChild(yj()),u.appendChild(a("g")),I=k(a("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),I.appendChild(a("g")),t=v("cg-auto-pieces"),j.appendChild(u),j.appendChild(I),j.appendChild(t)),L.coordinates){let y=L.orientation==="black"?" black":"",i=L.ranksPosition==="left"?" left":"";if(L.coordinatesOnSquares){let A=L.orientation==="white"?T=>T+1:T=>8-T;tM.forEach((T,D)=>j.appendChild(SL(TM.map(S=>T+S),"squares rank"+A(D)+y+i)))}else j.appendChild(SL(TM,"ranks"+y+i)),j.appendChild(SL(tM,"files"+y))}let g;return L.draggable.enabled&&L.draggable.showGhost&&(g=v("piece","ghost"),cM(g,!1),j.appendChild(g)),{board:N,container:j,wrap:M,ghost:g,svg:u,customSvg:I,autoPieces:t}}function SL(M,L){let j=v("coords",L),N;for(let u of M)N=v("coord"),N.textContent=u,j.appendChild(N);return j}function zj(M,L){if(!M.dropmode.active)return;P(M),G(M);let j=M.dropmode.piece;if(j){M.pieces.set("a0",j);let N=V(L),u=N&&W(N,Y(M),M.dom.bounds());u&&hM(M,"a0",u)}M.dom.redraw()}function xj(M,L){let j=M.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(L).observe(M.dom.elements.wrap),(M.disableContextMenu||M.drawable.enabled)&&j.addEventListener("contextmenu",u=>u.preventDefault()),M.viewOnly)return;let N=Y4(M);j.addEventListener("touchstart",N,{passive:!1}),j.addEventListener("mousedown",N,{passive:!1})}function cj(M,L){let j=[];if("ResizeObserver"in window||j.push(oM(document.body,"chessground.resize",L)),!M.viewOnly){let N=ej(M,qL,VL),u=ej(M,KL,_L);for(let t of["touchmove","mousemove"])j.push(oM(document,t,N));for(let t of["touchend","mouseup"])j.push(oM(document,t,u));let I=()=>M.dom.bounds.clear();j.push(oM(document,"scroll",I,{capture:!0,passive:!0})),j.push(oM(window,"resize",I,{passive:!0}))}return()=>j.forEach(N=>N())}function oM(M,L,j,N){return M.addEventListener(L,j,N),()=>M.removeEventListener(L,j,N)}var Y4=M=>L=>{M.draggable.current?yM(M):M.drawable.current?yL(M):L.shiftKey||dM(L)?M.drawable.enabled&&HL(M,L):M.viewOnly||(M.dropmode.active?zj(M,L):XL(M,L))},ej=(M,L,j)=>N=>{M.drawable.current?M.drawable.enabled&&j(M,N):M.viewOnly||L(M,N)};function Cj(M){let L=Y(M),j=LM(M.dom.bounds()),N=M.dom.elements.board,u=M.pieces,I=M.animation.current,t=I?I.plan.anims:new Map,g=I?I.plan.fadings:new Map,y=M.draggable.current,i=s4(M),A=new Set,T=new Set,D=new Map,S=new Map,e,z,r,o,n,E,U,s,jM,NM;for(z=N.firstChild;z;){if(e=z.cgKey,oj(z))if(r=u.get(e),n=t.get(e),E=g.get(e),o=z.cgPiece,z.cgDragging&&(!y||y.orig!==e)&&(z.classList.remove("dragging"),Z(z,j(C(e),L)),z.cgDragging=!1),!E&&z.cgFading&&(z.cgFading=!1,z.classList.remove("fading")),r){if(n&&z.cgAnimating&&o===rM(r)){let O=C(e);O[0]+=n[2],O[1]+=n[3],z.classList.add("anim"),Z(z,j(O,L))}else z.cgAnimating&&(z.cgAnimating=!1,z.classList.remove("anim"),Z(z,j(C(e),L)),M.addPieceZIndex&&(z.style.zIndex=AL(C(e),L)));o===rM(r)&&(!E||!z.cgFading)?A.add(e):E&&o===rM(E)?(z.classList.add("fading"),z.cgFading=!0):zL(D,o,z)}else zL(D,o,z);else if(rj(z)){let O=z.className;i.get(e)===O?T.add(e):zL(S,O,z)}z=z.nextSibling}for(let[O,X]of i)if(!T.has(O)){jM=S.get(X),NM=jM&&jM.pop();let H=j(C(O),L);if(NM)NM.cgKey=O,Z(NM,H);else{let R=v("square",X);R.cgKey=O,Z(R,H),N.insertBefore(R,N.firstChild)}}for(let[O,X]of u)if(n=t.get(O),!A.has(O))if(U=D.get(rM(X)),s=U&&U.pop(),s){s.cgKey=O,s.cgFading&&(s.classList.remove("fading"),s.cgFading=!1);let H=C(O);M.addPieceZIndex&&(s.style.zIndex=AL(H,L)),n&&(s.cgAnimating=!0,s.classList.add("anim"),H[0]+=n[2],H[1]+=n[3]),Z(s,j(H,L))}else{let H=rM(X),R=v("piece",H),YM=C(O);R.cgPiece=H,R.cgKey=O,n&&(R.cgAnimating=!0,YM[0]+=n[2],YM[1]+=n[3]),Z(R,j(YM,L)),M.addPieceZIndex&&(R.style.zIndex=AL(YM,L)),N.appendChild(R)}for(let O of D.values())Ej(M,O);for(let O of S.values())Ej(M,O)}function Oj(M){let L=Y(M),j=LM(M.dom.bounds()),N=M.dom.elements.board.firstChild;for(;N;)(oj(N)&&!N.cgAnimating||rj(N))&&Z(N,j(C(N.cgKey),L)),N=N.nextSibling}function eL(M){var L,j;let N=M.dom.elements.wrap.getBoundingClientRect(),u=M.dom.elements.container,I=N.height/N.width,t=Math.floor(N.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,g=t*I;u.style.width=t+"px",u.style.height=g+"px",M.dom.bounds.clear(),(L=M.addDimensionsCssVarsTo)===null||L===void 0||L.style.setProperty("---cg-width",t+"px"),(j=M.addDimensionsCssVarsTo)===null||j===void 0||j.style.setProperty("---cg-height",g+"px")}var oj=M=>M.tagName==="PIECE",rj=M=>M.tagName==="SQUARE";function Ej(M,L){for(let j of L)M.dom.elements.board.removeChild(j)}function AL(M,L){let N=M[1];return`${L?10-N:3+N}`}var rM=M=>`${M.color} ${M.role}`;function s4(M){var L,j,N;let u=new Map;if(M.lastMove&&M.highlight.lastMove)for(let g of M.lastMove)J(u,g,"last-move");if(M.check&&M.highlight.check&&J(u,M.check,"check"),M.selected&&(J(u,M.selected,"selected"),M.movable.showDests)){let g=(L=M.movable.dests)===null||L===void 0?void 0:L.get(M.selected);if(g)for(let i of g)J(u,i,"move-dest"+(M.pieces.has(i)?" oc":""));let y=(N=(j=M.premovable.customDests)===null||j===void 0?void 0:j.get(M.selected))!==null&&N!==void 0?N:M.premovable.dests;if(y)for(let i of y)J(u,i,"premove-dest"+(M.pieces.has(i)?" oc":""))}let I=M.premovable.current;if(I)for(let g of I)J(u,g,"current-premove");else M.predroppable.current&&J(u,M.predroppable.current.key,"current-premove");let t=M.exploding;if(t)for(let g of t.keys)J(u,g,"exploding"+t.stage);return M.highlight.custom&&M.highlight.custom.forEach((g,y)=>{J(u,y,g)}),u}function J(M,L,j){let N=M.get(L);N?M.set(L,`${N} ${j}`):M.set(L,j)}function zL(M,L,j){let N=M.get(L);N?N.push(j):M.set(L,[j])}function nj(M,L,j){let N=new Map,u=[];for(let g of M)N.set(g.hash,!1);let I=L.firstElementChild,t;for(;I;)t=I.getAttribute("cgHash"),N.has(t)?N.set(t,!0):u.push(I),I=I.nextElementSibling;for(let g of u)L.removeChild(g);for(let g of M)N.get(g.hash)||L.appendChild(j(g))}function Yj(M,L){let N=M.drawable.autoShapes.filter(u=>u.piece).map(u=>({shape:u,hash:Q4(u),current:!1}));nj(N,L,u=>w4(M,u,M.dom.bounds()))}function aj(M){var L;let j=Y(M),N=LM(M.dom.bounds()),u=(L=M.dom.elements.autoPieces)===null||L===void 0?void 0:L.firstChild;for(;u;)JM(u,N(C(u.cgKey),j),u.cgScale),u=u.nextSibling}function w4(M,{shape:L,hash:j},N){var u,I,t;let g=L.orig,y=(u=L.piece)===null||u===void 0?void 0:u.role,i=(I=L.piece)===null||I===void 0?void 0:I.color,A=(t=L.piece)===null||t===void 0?void 0:t.scale,T=v("piece",`${y} ${i}`);return T.setAttribute("cgHash",j),T.cgKey=g,T.cgScale=A,JM(T,LM(N)(C(g),Y(M)),A),T}var Q4=M=>{var L,j,N;return[M.orig,(L=M.piece)===null||L===void 0?void 0:L.role,(j=M.piece)===null||j===void 0?void 0:j.color,(N=M.piece)===null||N===void 0?void 0:N.scale].join(",")};function sj(M,L){let j=uj();fM(j,L||{});function N(){let u="dom"in j?j.dom.unbind:void 0,I=Aj(M,j),t=wL(()=>I.board.getBoundingClientRect()),g=A=>{Cj(i),I.autoPieces&&Yj(i,I.autoPieces),!A&&I.svg&&ij(i,I.svg,I.customSvg)},y=()=>{eL(i),Oj(i),I.autoPieces&&aj(i)},i=j;return i.dom={elements:I,bounds:t,redraw:l4(g),redrawNow:g,unbind:u},i.drawable.prevSvgHash="",eL(i),g(!1),xj(i,y),u||(i.dom.unbind=cj(i,y)),i.events.insert&&i.events.insert(I),i}return Nj(N(),N)}function l4(M){let L=!1;return()=>{L||(L=!0,requestAnimationFrame(()=>{M(),L=!1}))}}var GM=class{moveEventListeners=[];constructor(L){this.board=new DM,this.cg=sj(document.getElementById(L),{draggable:{enabled:!1},animation:{enabled:!1},premovable:{enabled:!1}})}toggleOrientation(){this.cg.toggleOrientation()}resetToFEN(L,j="auto"){let N=(u,I)=>{let t=this.board.move({from:u,to:I,promotion:"q"});this.cg.set({fen:this.board.fen(),turnColor:nM(this.board),check:this.board.inCheck(),movable:{color:nM(this.board),dests:wj(this.board)}});for(let g of this.moveEventListeners)g(t)};this.board.load(L,{skipValidation:!0}),this.cg.cancelMove(),this.cg.cancelPremove(),j==="auto"&&(j=nM(this.board)),this.cg.set({fen:L,orientation:j,lastMove:void 0,check:this.board.inCheck(),turnColor:nM(this.board),movable:{free:!1,dests:wj(this.board),color:nM(this.board),events:{after:N}}})}addMoveEventListener(L){this.moveEventListeners.push(L)}};function nM(M){return M.turn()==="w"?"white":"black"}function wj(M){let L=new Map;return OL.forEach(j=>{let N=M.moves({square:j,verbose:!0});N.length&&L.set(j,N.map(u=>u.to))}),L}var WM=class{moves=[];curMoveIndex=0;moveEventListeners=[];constructor(L){this.$tableElem=$(`#${L}`)}reset(L=[]){this.moves=L,this.curMoveIndex=0,this.render()}#M(){for(let L of this.moveEventListeners)L(this.curMoveIndex)}render(){let L=j=>{let N=this.curMoveIndex;this.setCurrentMove(j),N!==this.curMoveIndex&&this.#M()};this.$tableElem.empty();for(let j=0;j<this.moves.length;j+=2){let N=$("<tr></tr>");N.append(`<th>${j/2+1}</th>`),N.append($(`<td>${this.moves[j]}</td>`).click(()=>{L(j)})),this.moves[j+1]&&N.append($(`<td>${this.moves[j+1]}</td>`).click(()=>{L(j+1)})),this.$tableElem.append(N)}this.setCurrentMove(this.curMoveIndex)}constrainMoveIndex(L){return L<0||this.moves.length===0?0:L>=this.moves.length?this.moves.length-1:L}getCurrentMoveIndex(){return this.curMoveIndex}setCurrentMove(L){L=this.constrainMoveIndex(L),this.$tableElem.find("td").removeClass("active"),this.$tableElem.find(`tr:nth-child(${Math.floor(L/2)+1}) td:nth-of-type(${L%2+1})`).addClass("active"),this.curMoveIndex=L}focusTop(L){if(this.moves.length===0)return;L=this.constrainMoveIndex(L);let j=this.$tableElem.parent(),u=this.$tableElem.find("td").eq(L).position().top;j.get(0).scrollTo(0,u)}focusBottom(L){if(this.moves.length===0)return;L=this.constrainMoveIndex(L);let j=this.$tableElem.parent(),N=this.$tableElem.find("td").eq(L),u=N.position().top+N.height();j.get(0).scrollTo(0,u-j.height())}isFullyVisible(L){if(this.moves.length===0)return!0;L=this.constrainMoveIndex(L);let j=this.$tableElem.parent(),N=j.get(0),u=this.$tableElem.find("td").eq(L),I=u.position().top,t=u.position().top+u.height();return I>=N.scrollTop&&t<=N.scrollTop+j.height()}gotoNextMove(){this.setCurrentMove(this.curMoveIndex+1),this.isFullyVisible(this.curMoveIndex)||this.focusBottom(this.curMoveIndex),this.#M()}gotoPrevMove(){this.setCurrentMove(this.curMoveIndex-1),this.isFullyVisible(this.curMoveIndex)||this.focusTop(this.curMoveIndex),this.#M()}gotoFirstMove(){this.setCurrentMove(0),this.focusBottom(this.curMoveIndex),this.#M()}gotoLastMove(){this.setCurrentMove(this.moves.length-1),this.focusBottom(this.curMoveIndex),this.#M()}pushMove(L){this.moves=this.moves.slice(0,this.curMoveIndex+1),this.moves.push(L),this.curMoveIndex+=1,this.render(),this.focusBottom(this.curMoveIndex)}getCurrentFEN(){return wM(this.moves.slice(0,this.curMoveIndex+1))}addMoveEventListener(L){this.moveEventListeners.push(L)}};var d4=new URLSearchParams(document.location.search),Qj=d4.get("FEN"),SM=document.getElementById("fen-input"),VN=document.getElementById("fen-copy");function xL(){return SM.value||SM.placeholder}$(document).ready(()=>{let M=new GM("main-board"),L=new WM("main-pgn-table"),j=u=>{$(SM).val(u),M.resetToFEN(u),L.reset()},N=u=>{let I=wM(u);$(SM).val(I),M.resetToFEN(I),L.reset(u),L.setCurrentMove(u.length-1),L.focusBottom(u.length-1)};$("#btn-starting-position").click(()=>{j(rL)}),$("#btn-clear-board").click(()=>{j(nL)}),$("#btn-random-puzzle").click(function(){let u=$(this).text(),I=!1;setTimeout(()=>{I||$(this).text("Loading...")},500),$.getJSON("https://lichess.org/api/puzzle/next?angle=mate",g=>{I=!0,$(this).text(u),console.log("puzzle data",g);let y=g.game.pgn.split(" ");N(y)})}),$("#fen-copy").click(()=>{navigator.clipboard.writeText(xL())}),$("#fen-input").on("input",()=>{j(xL())}),L.addMoveEventListener(()=>{let u=L.getCurrentFEN();M.resetToFEN(u),$(SM).val(u)}),M.addMoveEventListener(u=>{L.pushMove(u.san),$(SM).val(M.board.FEN)}),document.addEventListener("keydown",u=>{u.code==="ArrowRight"?L.gotoNextMove():u.code==="ArrowLeft"?L.gotoPrevMove():u.code==="ArrowUp"?L.gotoFirstMove():u.code==="ArrowDown"?L.gotoLastMove():u.code==="KeyF"&&M.toggleOrientation()}),j(Qj||xL())});})();
/*! Bundled license information:

chess.js/dist/esm/chess.js:
  (**
   * @license
   * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
   * All rights reserved.
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are met:
   *
   * 1. Redistributions of source code must retain the above copyright notice,
   *    this list of conditions and the following disclaimer.
   * 2. Redistributions in binary form must reproduce the above copyright notice,
   *    this list of conditions and the following disclaimer in the documentation
   *    and/or other materials provided with the distribution.
   *
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
   * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
   * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
   * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
   * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
   * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
   * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
   * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
   * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
   * POSSIBILITY OF SUCH DAMAGE.
   *)
*/
//# sourceMappingURL=main.js.map
